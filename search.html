<html lang="en">
  <!--
      Allows dynamically searching for content in a Shotwell library inside a browser.

      Copyright (C) 2020 Brian Masney <masneyb@onstation.org>

      Licensed under the Apache License, Version 2.0 (the "License");
      you may not use this file except in compliance with the License.
      You may obtain a copy of the License at

          http://www.apache.org/licenses/LICENSE-2.0

      Unless required by applicable law or agreed to in writing, software
      distributed under the License is distributed on an "AS IS" BASIS,
      WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
      See the License for the specific language governing permissions and
      limitations under the License.
  -->

  <head>
    <meta name="viewport" content="width=device-width"/>
    <meta charset="UTF-8"/>
    <title>Search</title>
    <link rel="stylesheet" type="text/css" href="library.css"/>
    <script type="text/javascript" src="search.js"></script>
  </head>

  <body>
    <span id="title" class="page_title">Search</span>
    <span class="summary_stats"></span>
    <span class="header_links">
      <a id="screensaver_link" style="display: none">
        <span class="header_link">Screensaver with only these photos</span>
      </a>
    </span>
    <span class="header_links">
      <a href="#" id="shuffle_link" style="display: none"
       onclick="shuffleArray(allMedia); showMedia(1);">
        <span class="header_link">Shuffle media in search results</span>
      </a>
    </span>

    <span class="main_views">
      <span><a href="media/index.html"><span class="main_view">Date</span></a></span>
      <span><a href="event/index.html"><span class="main_view">Event</span></a></span>
      <span><a href="year/index.html"><span class="main_view">Year</span></a></span>
      <span><a href="tag/index.html"><span class="main_view">Tag</span></a></span>
      <span>
        <a href="search.html"><span class="main_view main_view_selected">Search</span></a>
      </span>
    </span>

    <span class="breadcrumbs" style="display: none">
      <a class="firstpage"><span class="breadcrumb">|&lt;</span></a>
      <a class="backten"><span class="breadcrumb">&lt;&lt;&lt;&lt;</span></a>
      <a class="backone"><span class="breadcrumb">&lt;&lt;</span></a>
      <span class="breadcrumb" id="page_info"></span>
      <a class="forwardone"><span class="breadcrumb">&gt;&gt;</span></a>
      <a class="forwardten"><span class="breadcrumb">&gt;&gt;&gt;&gt;</span></a>
      <a class="lastpage"><span class="breadcrumb">&gt;|</span></a>
    </span>

    <span id="search_criterias" style="display: none"></span>

    <span class="search_controls" style="display: none">
      <input type="button" onClick="addSearchInputRow();" value="+"></input>
      <select id="match_policy" onChange="updateSearchCriteria();">
        <option value="any">Match Any</option>
        <option value="all">Match All</option>
        <option value="none">Match None</option>
      </select>
      <input type="button" onClick="updateSearchCriteria();" value="Search"></input>
    </span>

    <div id="all_media"><div class='loading'>Loading</div></div>

    <span class="breadcrumbs" style="display: none">
      <a class="firstpage"><span class="breadcrumb">|&lt;</span></a>
      <a class="backten"><span class="breadcrumb">&lt;&lt;&lt;&lt;</span></a>
      <a class="backone"><span class="breadcrumb">&lt;&lt;</span></a>
      <span class="breadcrumb" id="page_info"></span>
      <a class="forwardone"><span class="breadcrumb">&gt;&gt;</span></a>
      <a class="forwardten"><span class="breadcrumb">&gt;&gt;&gt;&gt;</span></a>
      <a class="lastpage"><span class="breadcrumb">&gt;|</span></a>
    </span>

    <span class="generated_at">Site generated from
      <a href="https://wiki.gnome.org/Apps/Shotwell">Shotwell</a> library
      <span id="generated_timestamp"></span> by
      <a href="https://github.com/masneyb/shotwell-site-generator">shotwell-site-generator</a>
      <span id="app_version"></span>.
    </span>

    <template id="media_template">
      <span class="media">
        <a>
          <span class="media_thumb">
            <img></img>
          </span>
        </a>
        <span class="media_title"></span>
        <span class="media_comment"></span>
        <span class="media_metadata"></span>
      </span>
    </template>

    <template id="search_criteria_row">
      <span class="search_criteria">
        <select class="search_field"></select>
        <select class="search_op"></select>
        <span class="search_values"></span>
        <input class="search_delete_row" type="button" value="X"></input>
      </span>
    </template>

    <script type="text/javascript">
      function createAllStatsHtml() {
        var totalsByTypes = {};

        for (const media of allMedia) {
          if (!(media.type in totalsByTypes))
            totalsByTypes[media.type] = 1;
          else
            totalsByTypes[media.type]++;
        }

        var ret = []
        if ("photo" in totalsByTypes)
          ret.push(`<span class="stat">${totalsByTypes["photo"].toLocaleString()} photos</span>`);
        if ("video" in totalsByTypes)
          ret.push(`<span class="stat">${totalsByTypes["video"].toLocaleString()} videos</span>`);
        if ("events" in totalsByTypes)
          ret.push(`<span class="stat">${totalsByTypes["events"].toLocaleString()} events</span>`);
        if ("tags" in totalsByTypes)
          ret.push(`<span class="stat">${totalsByTypes["tags"].toLocaleString()} tags</span>`);

        return ret.join(", ");
      }

      function showMedia(pageNumber) {
        var allMediaEle = document.querySelector("#all_media");

        if (allMedia == null) {
          removeAllChildren(allMediaEle);
          return;
        }

        document.querySelector(".search_controls").style.display = "block";
        document.querySelector("#search_criterias").style.display = "block";

        if (allMedia.length == 0) {
           allMediaEle.innerHTML = "<div class='notfound'>No results found</div>";
           return;
        }

        const totalPages = Math.ceil(allMedia.length / pageSize);
        if (pageNumber < 1 || pageNumber > totalPages)
          return;

        removeAllChildren(allMediaEle);

        var template = document.querySelector("#media_template");
        var startIdx = (pageNumber - 1) * pageSize;

        for (const media of allMedia.slice(startIdx, startIdx + pageSize)) {
          var clone = template.content.cloneNode(true);

          clone.querySelector("a").href = media.link;
          clone.querySelector("img").src = media.thumbnail_path;

          if (media.title) {
            var name = `title${media.type}${media.id}`;
            clone.querySelector(".media_title").innerHTML = getExpandableString(name,
                                                                                media.title);
          }

          if (media.comment) {
            var name = `comment${media.type}${media.id}`;
            clone.querySelector(".media_comment").innerHTML = getExpandableString(name,
                                                                                  media.comment);
          }

          clone.querySelector(".media_metadata").innerHTML = createMediaStatsHtml(media, eventNames,
                                                                                  tagNames, false);

          allMediaEle.appendChild(clone);
        }

        var params = window.location.search.startsWith("?") ? window.location.search : "?";

        var screensaverLink = document.querySelector("#screensaver_link");
        screensaverLink.href = `screensaver.html${params}&photo_update_secs=10&kiosk=0`;
        screensaverLink.style.display = "block";
        document.querySelector("#shuffle_link").style.display = "block";

        document.querySelector(".summary_stats").innerHTML = createAllStatsHtml();

        for (var ele of document.querySelectorAll("#page_info"))
          ele.innerText = `Page ${pageNumber.toLocaleString()} of ${totalPages.toLocaleString()}`;

        for (ele of document.querySelectorAll(".breadcrumbs"))
          ele.style.display = totalPages == 1 ? "none" : "block";

        currentPageNumber = pageNumber;
        var lastPageNumber = Math.ceil(allMedia.length / pageSize);

        for (ele of document.querySelectorAll(".firstpage"))
          updateBreadcrumb(ele, 1, currentPageNumber > 1, totalPages > 2);

        for (ele of document.querySelectorAll(".backten"))
          updateBreadcrumb(ele, currentPageNumber - 10, currentPageNumber > 10, totalPages > 25);

        for (ele of document.querySelectorAll(".backone"))
          updateBreadcrumb(ele, currentPageNumber - 1, currentPageNumber > 1, true);

        for (ele of document.querySelectorAll(".forwardone"))
          updateBreadcrumb(ele, currentPageNumber + 1, currentPageNumber < lastPageNumber, true);

        for (ele of document.querySelectorAll(".forwardten"))
          updateBreadcrumb(ele, currentPageNumber + 10, currentPageNumber + 10 <= lastPageNumber,
                           totalPages > 25);

        for (ele of document.querySelectorAll(".lastpage"))
          updateBreadcrumb(ele, lastPageNumber, currentPageNumber < lastPageNumber, totalPages > 2);

        window.scrollTo(0, 0);
      }

      function updateBreadcrumb(ele, pageNumber, active, shown) {
        if (active && shown) {
          ele.style.display = "";
          ele.href = "#";
          ele.onclick = function() { showMedia(pageNumber); }
        } else if (!shown) {
          ele.style.display = "none";
        } else {
          ele.style.display = "";
          ele.removeAttribute("href");
          ele.onclick = "";
        }
      }

      function populateSearchFields(idx) {
        var searchEles = document.querySelector(`#search_criteria${idx}`);
        var select = searchEles.querySelector(".search_field");
        removeAllChildren(select);

        for (var field of searchFields) {
          var option = document.createElement("option");
          option.textContent = option.value = field.title;
          select.appendChild(option);
        }

        searchFieldChanged(idx);
      }

      function searchFieldChanged(idx) {
        var searchEles = document.querySelector(`#search_criteria${idx}`);
        var field = searchFields[searchEles.querySelector(".search_field").selectedIndex];

        var select = searchEles.querySelector(".search_op");
        removeAllChildren(select);

        for (var op of field.search.ops) {
          var option = document.createElement("option");
          option.textContent = option.value = op.descr;
          select.appendChild(option);
        }

        removeAllChildren(searchEles.querySelector(".search_values"));

        searchOpChanged(idx);
      }

      function updateCritieraIfValuesPopulated(idx) {
        var searchEles = document.querySelector(`#search_criteria${idx}`);
        for (var child of searchEles.querySelector(".search_values").children) {
          if (child.value == "")
            return;
        }

        updateSearchCriteria();
      }

      function removeAllChildren(node) {
        while (node.firstChild) {
          node.removeChild(node.firstChild);
        }
      }

      function createOptionNode(text, value) {
        var option = document.createElement("option");
        option.value = value;
        option.innerHTML = text;
        return option;
      }

      function searchOpChanged(idx) {
        var searchEles = document.querySelector(`#search_criteria${idx}`);
        var field = searchFields[searchEles.querySelector(".search_field").selectedIndex];
        var op = field.search.ops[searchEles.querySelector(".search_op").selectedIndex];

        var values = searchEles.querySelector(".search_values");
        if (op.numValues == values.children.length)
          return;

        removeAllChildren(values);

        for (var i = 0; i < op.numValues; i++) {
          if ("validValues" in field) {
            var select = document.createElement("select");
            select.appendChild(createOptionNode("", ""));
            for (var validValue of field.validValues)
              select.appendChild(createOptionNode(validValue[0], validValue[1]));
            select.addEventListener("change", function() { updateCritieraIfValuesPopulated(idx); });
            values.appendChild(select);
          } else {
            var input = document.createElement("input");
            input.className = `search_value${i}`;
            input.type = "inputType" in op ? op.inputType[i] : "text";
            if ("inputStep" in op)
              input.step = op.inputStep[i];
            input.size = 10;
            if ("placeholder" in op && op.placeholder[i] != null)
              input.placeholder = op.placeholder[i];

            input.addEventListener("change", function() { updateCritieraIfValuesPopulated(idx); });

            values.appendChild(input);
          }
        }
      }

      function addSearchInputRow() {
        var template = document.querySelector("#search_criteria_row");

        var row = template.content.cloneNode(true);
        row.querySelector(".search_criteria").id = `search_criteria${nextSearchInput}`;

        var fieldOnChange = function(idx) {
          return function() {
            searchFieldChanged(idx);
            updateCritieraIfValuesPopulated(idx);
          }
        };
        row.querySelector(".search_field").addEventListener("change",
                                                            fieldOnChange(nextSearchInput));

        var opOnChange = function(idx) {
          return function() {
            searchOpChanged(idx);
            updateCritieraIfValuesPopulated(idx);
          }
        };
        row.querySelector(".search_op").addEventListener("change", opOnChange(nextSearchInput));

        var delRow = function(idx) {
          return function() {
            var ele = document.querySelector(`#search_criteria${idx}`);
            ele.remove();
            updateSearchCriteria();
          }
        };
        row.querySelector(".search_delete_row").addEventListener("click", delRow(nextSearchInput));

        document.querySelector("#search_criterias").appendChild(row);
        populateSearchFields(nextSearchInput++);
      }

      function updateSearchCriteria() {
        var searchArgs = []
        for (var critChild of document.querySelector("#search_criterias").children) {
          const field = critChild.querySelector(".search_field").value;
          const op = critChild.querySelector(".search_op").value;

          var search = `${field},${op}`;
          for (var valChild of critChild.querySelector(".search_values").children) {
            search += `,${valChild.value}`;
          }
          searchArgs.push(`search=${encodeURIComponent(search)}`);
        }

        const matchPolicy = document.querySelector("#match_policy").value;
        window.location.href = `search.html?${searchArgs.join("&")}&match_policy=${matchPolicy}`;
      }

      function populateSearchValuesFromUrl() {
        var urlParams = new URLSearchParams(window.location.search);
        for (const searchCriteria of urlParams.getAll("search")) {
          var curIdx = nextSearchInput;
          addSearchInputRow();

          var parts = searchCriteria.split(",");
          if (parts.length < 2)
            continue;

          var searchEles = document.querySelector(`#search_criteria${curIdx}`);

          var fieldEle = searchEles.querySelector(".search_field");
          fieldEle.value = parts[0];
          searchFieldChanged(curIdx);
          var field = searchFields[fieldEle.selectedIndex];

          var opEle = searchEles.querySelector(".search_op")
          opEle.value = parts[1];
          searchOpChanged(curIdx);
          var op = field.search.ops[opEle.selectedIndex];

          for (var i = 0; i < Math.min(parts.length - 2, op.numValues); i++) {
            searchEles.querySelector(".search_values").children[i].value = parts[i + 2];
          }
        }

        var matchPolicy = getQueryParameter("match_policy", "all"); // any,none,all
        document.querySelector(`#match_policy`).value = matchPolicy;

        if (nextSearchInput == 0)
          addSearchInputRow();
      }

      function getExpandableString(name, value) {
        value = value.trim();
        if (value.length < 60 && !value.includes("\n"))
          return escapeString(value);

        var shortId = `${name}_short`;
        var longId = `${name}_long`;

        var shortVal = escapeString(value.substring(0, 50).trim() + "...");
        var longVal = escapeString(value).replace(/\n/g, "<br/>");

        var ret = `<span id="${shortId}" class="clickable"` +
                  `      style="display: block;" onClick="${jsHideShow(shortId, longId)}">` +
                  `${shortVal} &nbsp; <span class='more_less'>More</span>` +
                  '</span>';

        ret += `<span id="${longId}" class="clickable"` +
               `      style="display: none;" onClick="${jsHideShow(longId, shortId)}">` +
               `${longVal} &nbsp; <span class='more_less'>Less</span>` +
               '</span>';

        return ret;
      }

      function escapeString(input) {
        /*
         * Surely there has to be a built-in function for this? It's not encodeURI() or
         * encodeURIComponent() since it escapes too many characters, like spaces.
         */
        return input.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt");
      }

      function jsHideShow(hideElement, showElement) {
        return `document.getElementById('${showElement}').style.display='block'; ` +
               `document.getElementById('${hideElement}').style.display='none';`;
      }

      const pageSize = getIntQueryParameter("page_size", 24);

      var currentPageNumber = 1;
      var nextSearchInput = 0;
      var allMedia;

      var allMedia = null;
      var eventNames = null;
      var tagNames = null;

      loadJson(function(newAllMedia, newEventNames, newTagNames) {
        allMedia = newAllMedia;
        eventNames = newEventNames;
        tagNames = newTagNames;

        populateSearchValuesFromUrl();

        showMedia(1);
      }, function() {
        var allMediaEle = document.querySelector("#all_media");
        allMediaEle.innerHTML = "<div class='error'>Error loading media</div>";
      });
    </script>
  </body>
</html>
