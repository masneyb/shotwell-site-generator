<html lang="en">
  <head>
    <meta name="viewport" content="width=device-width"/>
    <meta charset="UTF-8"/>
    <title>Search</title>
    <link rel="stylesheet" type="text/css" href="library.css"/>
    <script type="text/javascript" src="search.js"></script>
  </head>

  <body>
    <span id="title" class="page_title">Search</span>
    <span class="summary_stats"></span>
    <span class="header_links">
      <a id="screensaver_link">
        <span class="header_link">Screensaver with only these photos</span>
      </a>
    </span>
    <span class="header_links">
      <a href="#" onclick="shuffleArray(allMedia); showMedia(1);">
        <span class="header_link">Shuffle media in search results</span>
      </a>
    </span>

    <span class="main_views">
      <span><a href="0/media/index.html"><span class="main_view">Date</span></a></span>
      <span><a href="0/event/index.html"><span class="main_view">Event</span></a></span>
      <span><a href="0/year/index.html"><span class="main_view">Year</span></a></span>
      <span><a href="0/tag/index.html"><span class="main_view">Tag</span></a></span>
      <span>
        <a href="search.html"><span class="main_view main_view_selected">Search</span></a>
      </span>
    </span>

    <span class="breadcrumbs">
      <a href="#" clas="skiplimits" onClick="showMedia(1)"><span class="breadcrumb">|&lt;</span></a>
      <a href="#" class="skip10" onClick="showMedia(currentPageNumber - 10)"><span class="breadcrumb">&lt;&lt;&lt;&lt;</span></a>
      <a href="#" onClick="showMedia(currentPageNumber - 1)"><span class="breadcrumb">&lt;&lt;</span></a>
      <span class="breadcrumb" id="page_info"></span>
      <a href="#" onClick="showMedia(currentPageNumber + 1)"><span class="breadcrumb">&gt;&gt;</span></a>
      <a href="#" class="skip10" onClick="showMedia(currentPageNumber + 10)"><span class="breadcrumb">&gt;&gt;&gt;&gt;</span></a>
      <a href="#" class="skiplimits" onClick="showMedia(Math.ceil(allMedia.length / pageSize))"><span class="breadcrumb">&gt;|</span></a>
    </span>

    <span id="search_criterias"></span>
    <span class="search_controls">
      <input type="button" onClick="addSearchInputRow();" value="+"></input>
      <select id="match_policy" onChange="updateSearchCriteria();">
        <option value="any">Match Any</option>
        <option value="all">Match All</option>
        <option value="none">Match None</option>
      </select>
      <input type="button" onClick="updateSearchCriteria();" value="Search"></input>
    </span>

    <div id="all_media"><div class='loading'>Loading</div></div>

    <span class="breadcrumbs">
      <a href="#" clas="skiplimits" onClick="showMedia(1)"><span class="breadcrumb">|&lt;</span></a>
      <a href="#" class="skip10" onClick="showMedia(currentPageNumber - 10)"><span class="breadcrumb">&lt;&lt;&lt;&lt;</span></a>
      <a href="#" onClick="showMedia(currentPageNumber - 1)"><span class="breadcrumb">&lt;&lt;</span></a>
      <span class="breadcrumb" id="page_info"></span>
      <a href="#" onClick="showMedia(currentPageNumber + 1)"><span class="breadcrumb">&gt;&gt;</span></a>
      <a href="#" class="skip10" onClick="showMedia(currentPageNumber + 10)"><span class="breadcrumb">&gt;&gt;&gt;&gt;</span></a>
      <a href="#" class="skiplimits" onClick="showMedia(Math.ceil(allMedia.length / pageSize))"><span class="breadcrumb">&gt;|</span></a>
    </span>

    <span class="generated_at">Site generated from
      <a href="https://wiki.gnome.org/Apps/Shotwell">Shotwell</a> library at
      <span id="generated_timestamp"></span> by
      <a href="https://github.com/masneyb/shotwell-site-generator">shotwell-site-generator</a>
      <span id="app_version"></span>.
    </span>

    <template id="media_template">
      <span class="media">
        <a>
          <span class="media_thumb">
            <img></img>
          </span>
        </a>
        <span class="media_title"></span>
        <span class="media_metadata"></span>
      </span>
    </template>

    <template id="search_criteria_row">
      <span class="search_criteria">
        <select class="search_field"></select>
        <select class="search_op"></select>
        <span class="search_values"></span>
        <input class="search_delete_row" type="button" value="X"></input>
      </span>
    </template>

    <script type="text/javascript">
      function createAllStatsHtml() {
        var totalsByTypes = {};

        for (const media of allMedia) {
          if (!(media.type in totalsByTypes))
            totalsByTypes[media.type] = 1;
          else
            totalsByTypes[media.type]++;
        }

        var ret = []
        if ("photo" in totalsByTypes)
          ret.push(`<span class="stat">${totalsByTypes["photo"].toLocaleString()} photos</span>`);
        if ("video" in totalsByTypes)
          ret.push(`<span class="stat">${totalsByTypes["video"].toLocaleString()} videos</span>`);
        if ("events" in totalsByTypes)
          ret.push(`<span class="stat">${totalsByTypes["events"].toLocaleString()} events</span>`);
        if ("tags" in totalsByTypes)
          ret.push(`<span class="stat">${totalsByTypes["tags"].toLocaleString()} tags</span>`);

        return ret.join(", ");
      }

      function showMedia(pageNumber) {
        var allMediaEle = document.querySelector("#all_media");

        if (allMedia == null) {
          removeAllChildren(allMediaEle);
          return;
        }

        if (allMedia.length == 0) {
           allMediaEle.innerHTML = "<div class='notfound'>No results found</div>";
           return;
        }

        const totalPages = Math.ceil(allMedia.length / pageSize);
        if (pageNumber < 1 || pageNumber > totalPages)
          return;

        removeAllChildren(allMediaEle);

        var template = document.querySelector("#media_template");
        var startIdx = (pageNumber - 1) * pageSize;

        for (const media of allMedia.slice(startIdx, startIdx + pageSize)) {
          var clone = template.content.cloneNode(true);

          clone.querySelector("a").href = media.link;
          clone.querySelector("img").src = media.thumbnail_path;
          if (media.title)
            clone.querySelector(".media_title").innerText = media.title;

          clone.querySelector(".media_metadata").innerHTML = createMediaStatsHtml(media, eventNames,
                                                                                  tagNames, false);

          allMediaEle.appendChild(clone);
        }

        var params = window.location.search.startsWith("?") ? window.location.search : "?";
        document.querySelector("#screensaver_link").href =
            `screensaver.html${params}&photo_update_secs=10&kiosk=0`;

        document.querySelector(".summary_stats").innerHTML = createAllStatsHtml();

        for (var ele of document.querySelectorAll("#page_info"))
          ele.innerText = `Page ${pageNumber.toLocaleString()} of ${totalPages.toLocaleString()}`;

        for (ele of document.querySelectorAll(".breadcrumbs"))
          ele.style.display = totalPages == 1 ? "none" : "block";

        currentPageNumber = pageNumber;

        for (ele of document.querySelectorAll(".skip10"))
          ele.style.display = totalPages > 25 ? "" : "none";

        for (ele of document.querySelectorAll(".skiplimits"))
          ele.style.display = totalPages > 2 ? "" : "none";

        window.scrollTo(0, 0);
      }

      function populateSearchFields(idx) {
        var searchEles = document.querySelector(`#search_criteria${idx}`);
        var select = searchEles.querySelector(".search_field");
        removeAllChildren(select);

        for (var field of searchFields) {
          var option = document.createElement("option");
          option.textContent = option.value = field.title;
          select.appendChild(option);
        }

        searchFieldChanged(idx);
      }

      function searchFieldChanged(idx) {
        var searchEles = document.querySelector(`#search_criteria${idx}`);
        var field = searchFields[searchEles.querySelector(".search_field").selectedIndex];

        var select = searchEles.querySelector(".search_op");
        removeAllChildren(select);

        for (var op of field.search.ops) {
          var option = document.createElement("option");
          option.textContent = option.value = op.descr;
          select.appendChild(option);
        }

        removeAllChildren(searchEles.querySelector(".search_values"));

        searchOpChanged(idx);
      }

      function updateCritieraIfValuesPopulated(idx) {
        var searchEles = document.querySelector(`#search_criteria${idx}`);
        for (var child of searchEles.querySelector(".search_values").children) {
          if (child.value == "")
            return;
        }

        updateSearchCriteria();
      }

      function removeAllChildren(node) {
        while (node.firstChild) {
          node.removeChild(node.firstChild);
        }
      }

      function searchOpChanged(idx) {
        var searchEles = document.querySelector(`#search_criteria${idx}`);
        var field = searchFields[searchEles.querySelector(".search_field").selectedIndex];
        var op = field.search.ops[searchEles.querySelector(".search_op").selectedIndex];

        var values = searchEles.querySelector(".search_values");
        if (op.numValues == values.children.length)
          return;

        removeAllChildren(values);

        for (var i = 0; i < op.numValues; i++) {
          if ("validValues" in field) {
            var select = document.createElement("select");
            for (var validValue of field.validValues) {
              var option = document.createElement("option");
              option.value = validValue[1];
              option.innerHTML = validValue[0];
              select.appendChild(option);
            }
            select.addEventListener("change", function() { updateCritieraIfValuesPopulated(idx); });
            values.appendChild(select);
          } else {
            var input = document.createElement("input");
            input.className = `search_value${i}`;
            input.type = "inputType" in op ? op.inputType[i] : "text";
            if ("inputStep" in op)
              input.step = op.inputStep[i];
            input.size = 10;
            input.addEventListener("change", function() { updateCritieraIfValuesPopulated(idx); });

            values.appendChild(input);
          }
        }
      }

      function addSearchInputRow() {
        var template = document.querySelector("#search_criteria_row");

        var row = template.content.cloneNode(true);
        row.querySelector(".search_criteria").id = `search_criteria${nextSearchInput}`;

        var fieldOnChange = function(idx) {
          return function() {
            searchFieldChanged(idx);
            updateCritieraIfValuesPopulated(idx);
          }
        };
        row.querySelector(".search_field").addEventListener("change",
                                                            fieldOnChange(nextSearchInput));

        var opOnChange = function(idx) {
          return function() {
            searchOpChanged(idx);
            updateCritieraIfValuesPopulated(idx);
          }
        };
        row.querySelector(".search_op").addEventListener("change", opOnChange(nextSearchInput));

        var delRow = function(idx) {
          return function() {
            var ele = document.querySelector(`#search_criteria${idx}`);
            ele.remove();
            updateSearchCriteria();
          }
        };
        row.querySelector(".search_delete_row").addEventListener("click", delRow(nextSearchInput));

        document.querySelector("#search_criterias").appendChild(row);
        populateSearchFields(nextSearchInput++);
      }

      function updateSearchCriteria() {
        var searchArgs = []
        for (var critChild of document.querySelector("#search_criterias").children) {
          const field = critChild.querySelector(".search_field").value;
          const op = critChild.querySelector(".search_op").value;

          var search = `${field},${op}`;
          for (var valChild of critChild.querySelector(".search_values").children) {
            search += `,${valChild.value}`;
          }
          searchArgs.push(`search=${encodeURIComponent(search)}`);
        }

        const matchPolicy = document.querySelector("#match_policy").value;
        window.location.href = `search.html?${searchArgs.join("&")}&match_policy=${matchPolicy}`;
      }

      function populateSearchValuesFromUrl() {
        var urlParams = new URLSearchParams(window.location.search);
        for (const searchCriteria of urlParams.getAll("search")) {
          var curIdx = nextSearchInput;
          addSearchInputRow();

          var parts = searchCriteria.split(",");
          if (parts.length < 2)
            continue;

          var searchEles = document.querySelector(`#search_criteria${curIdx}`);

          var fieldEle = searchEles.querySelector(".search_field");
          fieldEle.value = parts[0];
          searchFieldChanged(curIdx);
          var field = searchFields[fieldEle.selectedIndex];

          var opEle = searchEles.querySelector(".search_op")
          opEle.value = parts[1];
          searchOpChanged(curIdx);
          var op = field.search.ops[opEle.selectedIndex];

          for (var i = 0; i < Math.min(parts.length - 2, op.numValues); i++) {
            searchEles.querySelector(".search_values").children[i].value = parts[i + 2];
          }
        }

        var matchPolicy = getQueryParameter("match_policy", "all"); // any,none,all
        document.querySelector(`#match_policy`).value = matchPolicy;

        if (nextSearchInput == 0)
          addSearchInputRow();
      }

      const pageSize = getIntQueryParameter("page_size", 24);

      var currentPageNumber = 1;
      var nextSearchInput = 0;
      var allMedia;

      var allMedia = null;
      var eventNames = null;
      var tagNames = null;

      loadJson(function(newAllMedia, newEventNames, newTagNames) {
        allMedia = newAllMedia;
        eventNames = newEventNames;
        tagNames = newTagNames;

        showMedia(1);
      }, function() {
        var allMediaEle = document.querySelector("#all_media");
        allMediaEle.innerHTML =
          "<div class='error'>" +
          "There was an error loading the JSON document. If you are accessing this using a " +
          "file:// URI, then this error is most likely due to browser mitigations that are in " +
          "place for " +
          "<a href='https://nvd.nist.gov/vuln/detail/CVE-2019-11730'>CVE-2019-11730</a>. The " +
          "search and screensaver pages will work correctly when accessed over a http:// or " +
          "https:// URI. More information about this issue is available from " +
          "<a href='https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS/Errors/CORSRequestNotHttp'>Mozilla</a>. " +
          "You can work around this issue by starting a web server on your machine with " +
          "'python3 -mhttp.server' and then access this photo library with " +
          "<a href='http://localhost:8000'>http://localhost:8000</a>. All of the other " +
          "statically-generated pages on this site will work correctly when accessed over a " +
          "file:// URI." +
          "</div>";
      });

      populateSearchValuesFromUrl();
    </script>
  </body>
</html>
