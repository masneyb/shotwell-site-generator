<html lang="en">
  <!--
      SPDX-License-Identifier: Apache-2.0
      Copyright (C) 2020-2021 Brian Masney <masneyb@onstation.org>

      Allows dynamically searching for content in a Shotwell library inside a browser.
  -->

  <head>
    <meta name="viewport" content="width=device-width"/>
    <meta charset="UTF-8"/>
    <title>Search</title>
    <link rel="stylesheet" type="text/css" href="library.css"/>
    <script type="text/javascript" src="search.js"></script>
  </head>

  <body>
    <span id="title" class="page_title">Search</span>
    <span class="summary_stats"></span>
    <span class="header_links" style="display: none">
      <a href="#" id="csv_link"><span class="header_link">CSV</span></a>
      ·
      <a id="screensaver_link"><span class="header_link">Screensaver</span></a>
      ·
      <a href="#" onClick="toggleMetadata();"><span class="header_link" id="toggle_metadata">Hide Metadata</span></a>
      ·
      <a href="#" onClick="toggleAnimations();"><span class="header_link" id="toggle_animations">Show Animations</span></a>
    </span>
    <span id="saved_searches" class="header_links" style="display: none"></span>

    <span class="main_views"><span><a href="media/index.html"><span class="main_view">Date</span></a></span><span><a href="event/index.html"><span class="main_view">Event</span></a></span><span><a href="year/index.html"><span class="main_view">Year</span></a></span><span><a href="tag/index.html"><span class="main_view">Tag</span></a></span><span id="extra_header"></span><span><a href="search.html"><span class="main_view main_view_selected">Search</span></a></span></span>

    <span id="search_criterias" style="display: none"></span>

    <span class="search_controls" style="display: none">
      <input type="button" onClick="addSearchInputRow();" value="+"></input>
      <select id="match_policy" onChange="updateSearchCriteria();">
        <option value="any">Match Any</option>
        <option value="all">Match All</option>
        <option value="none">Match None</option>
      </select>
      <select id="sortby" onChange="updateSearchCriteria();">
        <option value="taken">Sort date taken</option>
        <option value="created">Sort date added</option>
      </select>
      <input type="button" onClick="updateSearchCriteria();" value="Search"></input>
      <input type="button" onClick="clearSearchCriteria();" value="Clear"></input>
    </span>

    <div id="all_media"><div class='loading'>Loading</div></div>

    <span class="generated_at">Site generated from
      <a href="https://wiki.gnome.org/Apps/Shotwell">Shotwell</a> library
      <span id="generated_timestamp"></span> by
      <a href="https://github.com/masneyb/shotwell-site-generator">shotwell-site-generator</a>
      <span id="app_version"></span>.
    </span>

    <template id="media_template">
      <span class="media">
        <span class="date_title">&nbsp;</span>
        <a target="_new">
          <span class="media_thumb">
            <img></img>
          </span>
        </a>
        <span class="media_title"></span>
        <span class="media_metadata"></span>
        <span class="media_comment"></span>
      </span>
    </template>

    <template id="search_criteria_row">
      <span class="search_criteria">
        <select class="search_field"></select>
        <select class="search_op"></select>
        <span class="search_values"></span>
        <input class="search_delete_row" type="button" value="X"></input>
      </span>
    </template>

    <script type="text/javascript">
      let currentPageNumber = 1;
      let nextSearchInput = 0;

      let allMedia = null;
      let eventNames = null;
      let tagNames = null;
      let metadataDisplay = 'block';
      let alwaysShowAnimations = false;
      let dateGroupTitle = null;

      function toggleMetadata() {
        metadataDisplay = metadataDisplay === 'none' ? 'block' : 'none';
        document.querySelector("#toggle_metadata").innerText = metadataDisplay === 'none' ? "Show Metadata" : "Hide Metadata";
        for (const name of ['.media_metadata', '.media_title', '.media_comment']) {
          for (const ele of document.querySelectorAll(name)) {
            ele.style.display = metadataDisplay;
          }
        }
      }

      function toggleAnimations() {
        alwaysShowAnimations = !alwaysShowAnimations;
        document.querySelector("#toggle_animations").innerText = alwaysShowAnimations ? "Hide Animations" : "Show Animations";
        showMedia();
      }

      function createAllStatsHtml() {
        const totalsByTypes = {};

        for (const media of allMedia) {
          let type = null;
          if (media.type === 'raw_photo' || media.type === 'motion_photo') {
            type = 'photo';
          } else {
            type = media.type;
          }

          if (!(type in totalsByTypes)) {
            totalsByTypes[type] = 1;
          } else {
            totalsByTypes[type] += 1;
          }
        }

        const ret = [];
        if ('photo' in totalsByTypes) {
          ret.push(`<span class="stat">${totalsByTypes.photo.toLocaleString()} photos</span>`);
        }
        if ('video' in totalsByTypes) {
          ret.push(`<span class="stat">${totalsByTypes.video.toLocaleString()} videos</span>`);
        }
        if ('events' in totalsByTypes) {
          ret.push(`<span class="stat">${totalsByTypes.events.toLocaleString()} events</span>`);
        }
        if ('years' in totalsByTypes) {
          ret.push(`<span class="stat">${totalsByTypes.years.toLocaleString()} years</span>`);
        }
        if ('tags' in totalsByTypes) {
          ret.push(`<span class="stat">${totalsByTypes.tags.toLocaleString()} tags</span>`);
        }

        return ret.join(' · ');
      }

      function jsHideShow(hideElement, showElement) {
        document.getElementById(showElement).style.display = 'block';
        document.getElementById(hideElement).style.display = 'none';
      }

      function getExpandableString(name, value) {
        const trimmedValue = value.trim();
        if (trimmedValue.length < 60 && !trimmedValue.includes('\n')) {
          return document.createTextNode(trimmedValue);
        }

        const shortId = `${name}_short`;
        const longId = `${name}_long`;

        const parentEle = document.createElement('span');

        let ele = document.createElement('span');
        ele.id = shortId;
        ele.style.display = 'block';
        ele.innerHTML = `${trimmedValue.substring(0, 50).trim()}... · <span class='more_less' onClick='jsHideShow("${shortId}", "${longId}");'>More</span>`;
        parentEle.appendChild(ele);

        ele = document.createElement('span');
        ele.id = longId;
        ele.style.display = 'none';
        const longValEscaped = trimmedValue.replace(/</g, '&lt;').replace(/>/g, '&gt').replace(/\n/g, '<br/>');
        ele.innerHTML = `${longValEscaped} · <span class='more_less' onClick='jsHideShow("${longId}", "${shortId}");'>Less</span>`;
        parentEle.appendChild(ele);

        return parentEle;
      }

      function removeAllChildren(node) {
        while (node.firstChild) {
          node.removeChild(node.firstChild);
        }
      }

      function hideResultsInfo() {
        removeAllChildren(document.querySelector('.summary_stats'));
        for (const search of ['.header_links']) {
          for (const ele of document.querySelectorAll(search)) {
            ele.style.display = 'none';
          }
        }
      }

      function createOptionNode(text, value) {
        const option = document.createElement('option');
        option.value = value;
        option.innerHTML = text;
        return option;
      }

      function updateSearchCriteria() {
        document.querySelector('#all_media').innerHTML = "<div class='loading'>Searching</div>";
        hideResultsInfo();

        window.setTimeout(() => {
          const searchArgs = [];
          for (const critChild of document.querySelector('#search_criterias').children) {
            const field = critChild.querySelector('.search_field').value;
            const op = critChild.querySelector('.search_op').value;

            let search = `${field},${op}`;
            for (const valChild of critChild.querySelector('.search_values').children) {
              search += `,${valChild.value}`;
            }
            searchArgs.push(`search=${encodeURIComponent(search)}`);
          }

          const matchPolicy = document.querySelector('#match_policy').value;
          const sortby = document.querySelector('#sortby').value;
          window.history.pushState({}, '',
            `search.html?${searchArgs.join('&')}&match_policy=${matchPolicy}&sortby=${sortby}`);
          processJson(getAllMediaViaJsFile(), populateMedia);
        }, 0);
      }

      function updateCritieraIfValuesPopulated(idx) {
        const searchEles = document.querySelector(`#search_criteria${idx}`);
        for (const child of searchEles.querySelector('.search_values').children) {
          if (child.value === '') {
            return;
          }
        }

        updateSearchCriteria();
      }

      function searchOpChanged(idx) {
        const searchEles = document.querySelector(`#search_criteria${idx}`);
        const field = searchFields[searchEles.querySelector('.search_field').selectedIndex];
        const op = field.search.ops[searchEles.querySelector('.search_op').selectedIndex];

        const values = searchEles.querySelector('.search_values');
        const existingValues = [];
        if (op.numValues === values.children.length) {
          for (const child of values.children) {
            existingValues.push([child.type, child.placeholder, child.value]);
          }
        }

        removeAllChildren(values);

        for (let i = 0; i < op.numValues; i += 1) {
          if ('validValues' in field) {
            const select = document.createElement('select');
            select.appendChild(createOptionNode('', ''));
            for (const validValue of field.validValues) {
              select.appendChild(createOptionNode(validValue[0], validValue[1]));
            }
            select.addEventListener('change', () => { updateCritieraIfValuesPopulated(idx); });
            values.appendChild(select);
          } else {
            const input = document.createElement('input');
            input.className = `search_value${i}`;
            input.type = 'inputType' in op ? op.inputType[i] : 'text';
            if ('inputStep' in op) {
              input.step = op.inputStep[i];
            }
            input.size = 10;
            input.placeholder = 'placeholder' in op && op.placeholder[i] != null ? op.placeholder[i] : '';

            input.addEventListener('change', () => { window.blur(); updateCritieraIfValuesPopulated(idx); });

            if (i < existingValues.length && existingValues[i][0] === input.type &&
                existingValues[i][1] === input.placeholder) {
              input.value = existingValues[i][2];
            }

            values.appendChild(input);
          }
        }
      }

      function searchFieldChanged(idx) {
        const searchEles = document.querySelector(`#search_criteria${idx}`);
        const field = searchFields[searchEles.querySelector('.search_field').selectedIndex];

        const select = searchEles.querySelector('.search_op');
        removeAllChildren(select);

        for (const op of field.search.ops) {
          const option = document.createElement('option');
          option.textContent = option.value = op.descr;
          select.appendChild(option);
        }

        searchOpChanged(idx);
      }

      function populateSearchFields(idx) {
        const searchEles = document.querySelector(`#search_criteria${idx}`);
        const select = searchEles.querySelector('.search_field');
        removeAllChildren(select);

        for (const field of searchFields) {
          const option = document.createElement('option');
          option.textContent = option.value = field.title;
          select.appendChild(option);
        }

        searchFieldChanged(idx);
      }

      function addSearchInputRow() {
        const template = document.querySelector('#search_criteria_row');

        const row = template.content.cloneNode(true);
        row.querySelector('.search_criteria').id = `search_criteria${nextSearchInput}`;

        const fieldOnChange = function (idx) {
          return function () {
            searchFieldChanged(idx);
            updateCritieraIfValuesPopulated(idx);
          };
        };
        row.querySelector('.search_field').addEventListener('change',
          fieldOnChange(nextSearchInput));

        const opOnChange = function (idx) {
          return function () {
            searchOpChanged(idx);
            updateCritieraIfValuesPopulated(idx);
          };
        };
        row.querySelector('.search_op').addEventListener('change', opOnChange(nextSearchInput));

        const delRow = function (idx) {
          return function () {
            const ele = document.querySelector(`#search_criteria${idx}`);
            ele.remove();
            updateSearchCriteria();
          };
        };
        row.querySelector('.search_delete_row').addEventListener('click', delRow(nextSearchInput));

        document.querySelector('#search_criterias').appendChild(row);
        populateSearchFields(nextSearchInput);
        nextSearchInput += 1;
      }

      function populateSearchValuesFromUrl() {
        removeAllChildren(document.querySelector('#search_criterias'));

        for (const searchCriteria of getSearchQueryParams()) {
          const curIdx = nextSearchInput;
          addSearchInputRow();

          const parts = searchCriteria.split(',');
          if (parts.length < 2) {
            continue;
          }

          const searchEles = document.querySelector(`#search_criteria${curIdx}`);

          const fieldEle = searchEles.querySelector('.search_field');
          fieldEle.value = parts[0];
          searchFieldChanged(curIdx);
          const field = searchFields[fieldEle.selectedIndex];

          const opEle = searchEles.querySelector('.search_op');
          opEle.value = parts[1];
          searchOpChanged(curIdx);
          const op = field.search.ops[opEle.selectedIndex];

          for (let i = 0; i < Math.min(parts.length - 2, op.numValues); i += 1) {
            searchEles.querySelector('.search_values').children[i].value = parts[i + 2];
          }
        }

        const matchPolicy = getQueryParameter('match_policy', 'all'); // any,none,all
        document.querySelector('#match_policy').value = matchPolicy;

        const sortby = getQueryParameter('sortby', 'taken'); // taken,created
        document.querySelector('#sortby').value = sortby;

        if (nextSearchInput === 0) {
          addSearchInputRow();
        }
      }

      function populateMedia(newAllMedia, newEventNames, newTagNames, extraHeader) {
        allMedia = newAllMedia;
        eventNames = newEventNames;
        tagNames = newTagNames;

        if (extraHeader) {
          const extraHeaderEle = document.querySelector('#extra_header');
          removeAllChildren(extraHeaderEle);

          const outerSpan = document.createElement('span');
          const anchor = document.createElement('a');
          anchor.href = extraHeader.link;
          const innerSpan = document.createElement('span');
          innerSpan.className = 'main_view';
          innerSpan.innerText = extraHeader.description;

          anchor.appendChild(innerSpan);
          outerSpan.appendChild(anchor);
          extraHeaderEle.appendChild(outerSpan);
        }

        showMedia();
        populateSearchValuesFromUrl();
      }

      function searchPageLinkGenerator(field, op, val) {
        const search = appendToExistingSearchUrl(`${field},${op},${val}`, true);
        window.history.pushState({}, '', search);
        processJson(getAllMediaViaJsFile(), populateMedia);
      }

      function writeCsvRow(cols) {
        let ret = '';
        for (let i = 0; i < cols.length; i += 1) {
          if (i > 0) {
            ret += ',';
          }
          ret += `"${encodeURIComponent(cols[i])}"`;
        }
        ret += encodeURIComponent('\n');

        return ret;
      }

      function getCsvUriData() {
        let ret = 'data:text/csv;charset=utf-8,';

        ret += writeCsvRow(['ID', 'Type', 'Path', 'Size', 'Rating', 'Width', 'Height',
                            'Exposure Time', 'Event ID', 'Latitude', 'Longitude', 'Title',
                            'Camera', 'Camera Settings']);

        for (const media of allMedia) {
          const cols = [];
          cols.push(media.id);
          cols.push(media.type);
          cols.push(media.link);
          cols.push('filesize' in media ? media.filesize.toString() : '');
          cols.push('rating' in media ? media.rating.toString() : '');
          cols.push('width' in media ? media.width.toString() : '');
          cols.push('height' in media ? media.height.toString() : '');
          cols.push('exposure_time' in media ? media.exposure_time : '');
          cols.push('event_id' in media ? media.event_id.toString() : '');
          cols.push('lat' in media ? media.lat.toString() : '');
          cols.push('lon' in media ? media.lon.toString() : '');
          cols.push('title' in media ? media.title : '');
          cols.push('camera' in media ? media.camera : '');
          cols.push('exif' in media ? media.exif.join(' ') : '');
          ret += writeCsvRow(cols);
        }

        return ret;
      }

      function downloadCsv(event) {
        if (event.detail !== 1) {
          return;
        }

        const link = document.createElement('a');
        link.href = getCsvUriData();
        link.download = 'media.csv';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      function doShowMedia(pageNumber) {
        const pageSize = 24;
        const lastPageNumber = Math.ceil(allMedia.length / pageSize);
        if (pageNumber > lastPageNumber) {
            return;
        }

        const allMediaEle = document.querySelector('#all_media');

        const template = document.querySelector('#media_template');
        const startIdx = (pageNumber - 1) * pageSize;
        const searchLinkGenerator = function (field, op, val) {
          return `href="#" onclick="searchPageLinkGenerator('${field}', '${op}', '${val}');"`;
        };

        for (const media of allMedia.slice(startIdx, startIdx + pageSize)) {
          const clone = template.content.cloneNode(true);

          clone.querySelector('a').href = media.link;

          if (alwaysShowAnimations && media.motion_photo_gif) {
            const img = clone.querySelector('img');
            img.src = media.motion_photo_gif;
          } else {
            const img = clone.querySelector('img');
            img.src = media.thumbnail_path;
            if (media.motion_photo_gif) {
              img.addEventListener('mouseover', () => { img.src = media.motion_photo_gif; });
              img.addEventListener('mouseleave', () => { img.src = media.thumbnail_path; });
              img.addEventListener('touchstart', () => { img.src = media.motion_photo_gif; });
              img.addEventListener('touchend', () => { img.src = media.thumbnail_path; });
            }
          }

          if (media.title) {
            const name = `title${media.type}${media.id}`;
            const title = clone.querySelector('.media_title');
            title.style.display = metadataDisplay;
            title.appendChild(getExpandableString(name, media.title));
          }

          if (media.comment) {
            const name = `comment${media.type}${media.id}`;
            const comment = clone.querySelector('.media_comment');
            comment.style.display = metadataDisplay;
            comment.appendChild(getExpandableString(name, media.comment));
          }

          const metadata = clone.querySelector('.media_metadata');
          metadata.style.display = metadataDisplay;
          metadata.innerHTML = createMediaStatsHtml(media, eventNames, tagNames,
                                                    searchLinkGenerator, false);

          if ('exposure_time_pretty' in media) {
            if (dateGroupTitle == null || dateGroupTitle !== media.exposure_time_pretty) {
              clone.querySelector('.date_title').innerText = media.exposure_time_pretty;
              dateGroupTitle = media.exposure_time_pretty;
            }
          } else if (dateGroupTitle != null) {
            dateGroupTitle = null;
          }

          allMediaEle.appendChild(clone);
        }

        currentPageNumber = pageNumber;
      }

      function showMedia() {
        const allMediaEle = document.querySelector('#all_media');

        if (allMedia == null) {
          removeAllChildren(allMediaEle);
          return;
        }

        document.querySelector('.search_controls').style.display = 'block';
        document.querySelector('#search_criterias').style.display = 'block';

        if (allMedia.length === 0) {
          allMediaEle.innerHTML = "<div class='notfound'>No results found</div>";
          hideResultsInfo();
          return;
        }

        removeAllChildren(allMediaEle);

        doShowMedia(1);

        const params = window.location.search.startsWith('?') ? window.location.search : '?';

        document.querySelector('#screensaver_link').href = `screensaver.html${params}&photo_update_secs=30&reinstate_screensaver_secs=300&kiosk=0`;

        for (const ele of document.querySelectorAll('.header_links')) {
          ele.style.display = 'block';
        }

        document.querySelector('#csv_link').addEventListener('click', (event) => { downloadCsv(event); });

        document.querySelector('.summary_stats').innerHTML = createAllStatsHtml();

        window.scrollTo(0, 0);
      }

      function windowScrolled() {
        if (window.innerHeight + window.scrollY >= (document.body.offsetHeight * 0.90)) {
           doShowMedia(currentPageNumber + 1);
        }
      }

      function clearSearchCriteria() {
        window.history.pushState({}, '', 'search.html');
        processJson(getAllMediaViaJsFile(), populateMedia);
      }

      function loadSavedSearches() {
        /*
         * Read the saved searches from a javascript file rather than as a JSON file using
         * XMLHttpRequest to work around browser mitigations that are in place for
         * CVE-2019-11730. This change allows the search page to function correctly when
         * accessed over a file URI.
         */

        const scr = document.createElement('script');
        scr.setAttribute('src', 'saved_searches.js');
        scr.onload = function () {
          const ele = document.querySelector('#saved_searches');
          const savedSearches = getSavedSearches();
          if (savedSearches.length == 0) {
            return;
          }

          for (let i = 0; i < savedSearches.length; i += 1) {
            if (i > 0) {
              const space = document.createElement('span');
              space.innerHTML = ' · ';
              ele.appendChild(space);
            }

            const anchor = document.createElement('a');
            anchor.href = savedSearches[i].url;
            anchor.innerText = savedSearches[i].label;
            ele.appendChild(anchor);
          }
        };
        document.body.appendChild(scr);
      }

      loadSavedSearches();

      loadJson(populateMedia, () => {
        const allMediaEle = document.querySelector('#all_media');
        allMediaEle.innerHTML = "<div class='error'>Error loading media</div>";
      });

      window.addEventListener("scroll", windowScrolled, false);

      window.onpopstate = function () {
        processJson(getAllMediaViaJsFile(), populateMedia);
      };
    </script>
  </body>
</html>
