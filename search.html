<html lang="en">
  <!--
      SPDX-License-Identifier: Apache-2.0
      Copyright (C) 2020-2021 Brian Masney <masneyb@onstation.org>

      Allows dynamically searching for content in a Shotwell library inside a browser.
  -->

  <head>
    <meta name="viewport" content="width=device-width"/>
    <meta charset="UTF-8"/>
    <title>Search</title>
    <link rel="stylesheet" type="text/css" href="library.css"/>
    <script type="text/javascript" src="search.js"></script>
    <script type="text/javascript" src="media.js" defer="defer" onLoad="processJson(populateMedia);" onError="jsonLoadError();"></script>
  </head>

  <body>
    <span id="title" class="page_title">Search</span>
    <span class="summary_stats"></span>
    <span class="header_links" style="display: none">
      <a href="#" id="csv_link"><span class="header_link">CSV</span></a>
      <a id="screensaver_link"><span class="header_link">Screensaver</span></a>
      <a href="#" onClick="toggleMetadata();"><span class="header_link" id="toggle_metadata">Hide Metadata</span></a>
      <a href="#" onClick="toggleAnimations();"><span class="header_link" id="toggle_animations">Show Animations</span></a>
      <a href="media/index.html"><span class="header_link">Static HTML Site</span></a>
    </span>

    <span class="main_views">
      <span>
        <a href="#" onclick="searchPageLinkGenerator(event, []);"`><span class="main_view">Date</span></a>
      </span>
      <span>
        <a href="#" onclick="searchPageLinkGenerator(event, [['Type', 'is a', 'events']]);"`><span id="events_link" class="main_view">Event</span></a>
      </span>
      <span>
        <a href="#" onclick="searchPageLinkGenerator(event, [['Type', 'is a', 'years']]);"`><span id="years_link" class="main_view">Year</span></a>
      </span>
      <span>
        <a href="#" onclick="searchPageLinkGenerator(event, [['Type', 'is a', 'tags'], ['Tag Parent ID', 'is not set']]);"`><span id="tags_link" class="main_view">Tag</span></a>
      </span>
      <span id="extra_header"></span>
    </span>

    <span id="search_criterias" style="display: none"></span>

    <span class="search_controls" style="display: none">
      <input type="button" onClick="addSearchInputRow();" value="+"></input>
      <select id="match_policy" onChange="updateSearchCriteria();">
        <option value="any">Match Any</option>
        <option value="all">Match All</option>
        <option value="none">Match None</option>
      </select>
      <select id="sortby" onChange="updateSearchCriteria();">
        <option value="taken">Sort date taken</option>
        <option value="created">Sort date added</option>
      </select>
      <input type="button" onClick="updateSearchCriteria();" value="Search"></input>
      <input type="button" onClick="clearSearchCriteria();" value="Clear"></input>
    </span>

    <div id="all_media"><div class='loading'>Loading</div></div>

    <span class="generated_at">Site generated from
      <a href="https://wiki.gnome.org/Apps/Shotwell">Shotwell</a> library
      <span id="generated_timestamp"></span> by
      <a href="https://github.com/masneyb/shotwell-site-generator">shotwell-site-generator</a>
      <span id="app_version"></span>.
    </span>

    <template id="media_template">
      <span class="media_dyn">
        <a><span class="media_thumb"><img></img></span></a>
        <span class="media_title"></span>
        <span class="media_comment"></span>
        <span class="media_metadata"></span>
      </span>
    </template>

    <template id="search_criteria_row">
      <span class="search_criteria">
        <select class="search_field"></select>
        <select class="search_op"></select>
        <span class="search_values"></span>
        <input class="search_delete_row" type="button" value="X"></input>
      </span>
    </template>

    <script type="text/javascript">
      function showMobileView() {
        return window.innerWidth < 600;
      }

      let currentPageNumber = 1;
      let nextSearchInput = 0;

      let allMedia = null;
      let eventNames = null;
      let tagNames = null;
      let metadataDisplay = 'block';
      let alwaysShowAnimations = false;
      let isMobileView = showMobileView();
      let currentYearView = null;

      function jsonLoadError() {
        const allMediaEle = document.querySelector('#all_media');
        allMediaEle.innerHTML = "<div class='error'>Error loading media</div>";
      }

      function toggleMetadata() {
        metadataDisplay = metadataDisplay === 'none' ? 'block' : 'none';
        document.querySelector('#toggle_metadata').innerText = metadataDisplay === 'none' ? 'Show Metadata' : 'Hide Metadata';
        for (const name of ['.media_metadata', '.media_title', '.media_comment']) {
          for (const ele of document.querySelectorAll(name)) {
            ele.style.display = metadataDisplay;
          }
        }
      }

      function toggleAnimations() {
        alwaysShowAnimations = !alwaysShowAnimations;
        document.querySelector('#toggle_animations').innerText = alwaysShowAnimations ? 'Hide Animations' : 'Show Animations';
        showMedia();
      }

      function createAllStatsHtml() {
        const totalsByTypes = {};
        let artifactSize = 0;
        let groupSize = 0;

        for (const media of allMedia) {
          let type = null;
          if (media.type === 'raw_photo' || media.type === 'motion_photo') {
            type = 'photo';
          } else {
            type = media.type;
          }

          if (!(type in totalsByTypes)) {
            totalsByTypes[type] = 1;
          } else {
            totalsByTypes[type] += 1;
          }

          if ('artifact_filesize' in media) {
            artifactSize += media.artifact_filesize;
          } else if ('filesize' in media && type !== 'tags') {
            groupSize += media.filesize;
          }
        }

        const ret = [];
        if ('photo' in totalsByTypes) {
          ret.push(`<span class="stat">${getNumberString(totalsByTypes.photo, 'photo', 'photos')}</span>`);
        }
        if ('video' in totalsByTypes) {
          ret.push(`<span class="stat">${getNumberString(totalsByTypes.video, 'video', 'videos')}</span>`);
        }
        if ('events' in totalsByTypes) {
          ret.push(`<span class="stat">${getNumberString(totalsByTypes.events, 'event', 'events')}</span>`);
        }
        if ('years' in totalsByTypes) {
          ret.push(`<span class="stat">${getNumberString(totalsByTypes.years, 'year', 'years')}</span>`);
        }
        if ('tags' in totalsByTypes) {
          ret.push(`<span class="stat">${getNumberString(totalsByTypes.tags, 'tag', 'tags')}</span>`);
        }

        if (artifactSize > 0) {
          ret.push(`<span class="stat">${getPrettyFileSize(artifactSize)}</span>`);
        } else if (groupSize > 0) {
          ret.push(`<span class="stat">${getPrettyFileSize(groupSize)}</span>`);
        }

        return ret.join(' · ');
      }

      function jsHideShow(hideElement, showElement) {
        document.getElementById(showElement).style.display = 'block';
        document.getElementById(hideElement).style.display = 'none';
      }

      function getExpandableString(name, value) {
        const trimmedValue = value.trim();
        if (trimmedValue.length < 150 && !trimmedValue.includes('\n')) {
          return document.createTextNode(trimmedValue);
        }

        const shortId = `${name}_short`;
        const longId = `${name}_long`;

        const parentEle = document.createElement('span');

        let ele = document.createElement('span');
        ele.id = shortId;
        ele.style.display = 'block';
        ele.innerHTML = `${trimmedValue.substring(0, 140).trim()}... · <span class='more_less' onClick='jsHideShow("${shortId}", "${longId}");'>More</span>`;
        parentEle.appendChild(ele);

        ele = document.createElement('span');
        ele.id = longId;
        ele.style.display = 'none';
        const longValEscaped = trimmedValue.replace(/</g, '&lt;').replace(/>/g, '&gt').replace(/\n/g, '<br/>');
        ele.innerHTML = `${longValEscaped} · <span class='more_less' onClick='jsHideShow("${longId}", "${shortId}");'>Less</span>`;
        parentEle.appendChild(ele);

        return parentEle;
      }

      function removeAllChildren(node) {
        while (node.firstChild) {
          node.removeChild(node.firstChild);
        }
      }

      function hideResultsInfo() {
        removeAllChildren(document.querySelector('.summary_stats'));
        for (const search of ['.header_links']) {
          for (const ele of document.querySelectorAll(search)) {
            ele.style.display = 'none';
          }
        }
      }

      function createOptionNode(text, value) {
        const option = document.createElement('option');
        option.value = value;
        option.innerHTML = text;
        return option;
      }

      function updateSearchCriteria() {
        document.querySelector('#all_media').innerHTML = "<div class='loading'>Searching</div>";
        hideResultsInfo();

        window.setTimeout(() => {
          const searchArgs = [];
          for (const critChild of document.querySelector('#search_criterias').children) {
            const field = critChild.querySelector('.search_field').value;
            const op = critChild.querySelector('.search_op').value;

            let search = `${field},${op}`;
            for (const valChild of critChild.querySelector('.search_values').children) {
              search += `,${valChild.value}`;
            }
            searchArgs.push(`search=${encodeURIComponent(search)}`);
          }

          const matchPolicy = document.querySelector('#match_policy').value;
          const sortby = document.querySelector('#sortby').value;
          window.history.pushState({}, '',
            `search.html?${searchArgs.join('&')}&match_policy=${matchPolicy}&sortby=${sortby}`);
          processJson(populateMedia);
        }, 0);
      }

      function updateCritieraIfValuesPopulated(idx) {
        const searchEles = document.querySelector(`#search_criteria${idx}`);
        for (const child of searchEles.querySelector('.search_values').children) {
          if (child.value === '') {
            return;
          }
        }

        updateSearchCriteria();
      }

      function searchOpChanged(idx) {
        const searchEles = document.querySelector(`#search_criteria${idx}`);
        const field = searchFields[searchEles.querySelector('.search_field').selectedIndex];
        const op = field.search.ops[searchEles.querySelector('.search_op').selectedIndex];

        const values = searchEles.querySelector('.search_values');
        const existingValues = [];
        if (op.numValues === values.children.length) {
          for (const child of values.children) {
            existingValues.push([child.type, child.placeholder, child.value]);
          }
        }

        removeAllChildren(values);

        for (let i = 0; i < op.numValues; i += 1) {
          if ('validValues' in field) {
            const select = document.createElement('select');
            select.appendChild(createOptionNode('', ''));
            for (const validValue of field.validValues) {
              select.appendChild(createOptionNode(validValue[0], validValue[1]));
            }
            select.addEventListener('change', () => { updateCritieraIfValuesPopulated(idx); });
            values.appendChild(select);
          } else {
            const input = document.createElement('input');
            input.className = `search_value${i}`;
            input.type = 'inputType' in op ? op.inputType[i] : 'text';
            if ('inputStep' in op) {
              input.step = op.inputStep[i];
            }
            const size = 'inputSize' in op ? op.inputSize[i] : 8;
            input.style.width = `${size}em`;
            input.placeholder = 'placeholder' in op && op.placeholder[i] != null ? op.placeholder[i] : '';

            input.addEventListener('change', () => { window.blur(); updateCritieraIfValuesPopulated(idx); });

            if (i < existingValues.length && existingValues[i][0] === input.type &&
                existingValues[i][1] === input.placeholder) {
              input.value = existingValues[i][2];
            }

            values.appendChild(input);
          }
        }
      }

      function searchFieldChanged(idx) {
        const searchEles = document.querySelector(`#search_criteria${idx}`);
        const field = searchFields[searchEles.querySelector('.search_field').selectedIndex];

        const select = searchEles.querySelector('.search_op');
        removeAllChildren(select);

        for (const op of field.search.ops) {
          const option = document.createElement('option');
          option.textContent = option.value = op.descr;
          select.appendChild(option);
        }

        searchOpChanged(idx);
      }

      function populateSearchFields(idx) {
        const searchEles = document.querySelector(`#search_criteria${idx}`);
        const select = searchEles.querySelector('.search_field');
        removeAllChildren(select);

        for (const field of searchFields) {
          const option = document.createElement('option');
          option.textContent = option.value = field.title;
          select.appendChild(option);
        }

        searchFieldChanged(idx);
      }

      function addSearchInputRow() {
        const template = document.querySelector('#search_criteria_row');

        const row = template.content.cloneNode(true);
        row.querySelector('.search_criteria').id = `search_criteria${nextSearchInput}`;

        const fieldOnChange = function (idx) {
          return function () {
            searchFieldChanged(idx);
            updateCritieraIfValuesPopulated(idx);
          };
        };
        row.querySelector('.search_field').addEventListener('change',
          fieldOnChange(nextSearchInput));

        const opOnChange = function (idx) {
          return function () {
            searchOpChanged(idx);
            updateCritieraIfValuesPopulated(idx);
          };
        };
        row.querySelector('.search_op').addEventListener('change', opOnChange(nextSearchInput));

        const delRow = function (idx) {
          return function () {
            const ele = document.querySelector(`#search_criteria${idx}`);
            ele.remove();
            updateSearchCriteria();
          };
        };
        row.querySelector('.search_delete_row').addEventListener('click', delRow(nextSearchInput));

        document.querySelector('#search_criterias').appendChild(row);
        populateSearchFields(nextSearchInput);
        nextSearchInput += 1;
      }

      function populateSearchValuesFromUrl() {
        removeAllChildren(document.querySelector('#search_criterias'));
        nextSearchInput = 0;

        for (const searchCriteria of getSearchQueryParams()) {
          const curIdx = nextSearchInput;
          addSearchInputRow();

          const parts = searchCriteria.split(',');
          if (parts.length < 2) {
            continue;
          }

          const searchEles = document.querySelector(`#search_criteria${curIdx}`);

          const fieldEle = searchEles.querySelector('.search_field');
          fieldEle.value = parts[0];
          searchFieldChanged(curIdx);
          const field = searchFields[fieldEle.selectedIndex];

          const opEle = searchEles.querySelector('.search_op');
          opEle.value = parts[1];
          searchOpChanged(curIdx);
          const op = field.search.ops[opEle.selectedIndex];

          for (let i = 0; i < Math.min(parts.length - 2, op.numValues); i += 1) {
            searchEles.querySelector('.search_values').children[i].value = parts[i + 2];
          }
        }

        const matchPolicy = getQueryParameter('match_policy', 'all'); // any,none,all
        document.querySelector('#match_policy').value = matchPolicy;

        const sortby = getQueryParameter('sortby', 'taken'); // taken,created
        document.querySelector('#sortby').value = sortby;

        if (nextSearchInput === 0) {
          addSearchInputRow();
        }
      }

      function setPageTitle(mediaTitle) {
        currentYearView = null;

        // Search criteria can be chained in any order. Get the distinct types and order below.
        let eventTitle = null;
        let yearTitle = null;
        let tagTitle = null;

        const allCriteria = getSearchCriteria();
        for (const criteria of allCriteria) {
          if (criteria.field.title === 'Type' && criteria.op.descr === 'is a' &&
              criteria.searchValues[0] === 'years') {
            yearTitle = `${mediaTitle}: All Years`;
          } else if (criteria.field.title === 'Year' && criteria.op.descr === 'equals') {
            yearTitle = `${mediaTitle}: Year ${criteria.searchValues[0]}`;
            // Used for generating search links when searching for events.
            currentYearView = criteria.searchValues[0];
          } else if (criteria.field.title === 'Type' && criteria.op.descr === 'is a' &&
                     criteria.searchValues[0] === 'events') {
            eventTitle = `${mediaTitle}: All Events`;
          } else if (criteria.field.title === 'Event ID' && criteria.op.descr === 'equals') {
            eventTitle = `${mediaTitle}: ${eventNames[criteria.searchValues[0]]}`;
          } else if (criteria.field.title === 'Type' && criteria.op.descr === 'is a' &&
                     criteria.searchValues[0] === 'tags') {
            tagTitle = `${mediaTitle}: All Tags`;
          } else if (criteria.field.title === 'Tag ID' && criteria.op.descr === 'equals') {
            tagTitle = `${mediaTitle}: ${tagNames[criteria.searchValues[0]]}`;
          }
        }

        const titles = [[eventTitle, 'events_link'], [yearTitle, 'years_link'],
                        [tagTitle, 'tags_link'], [`${mediaTitle}: Search`, null]];
        const preferredTitle = titles.find((ent) => ent[0] !== null);

        document.title = preferredTitle[0];
        const ele = document.querySelector('#title');
        if (ele) {
          ele.innerText = document.title;
        }

        if (preferredTitle[1] !== null) {
          document.querySelector(`#${preferredTitle[1]}`).classList.add('main_view_selected');
        }
        for (const tagName of ['years_link', 'events_link', 'tags_link']) {
          if (tagName !== preferredTitle[1]) {
            document.querySelector(`#${tagName}`).classList.remove('main_view_selected');
          }
        }
      }

      function populateMedia(newAllMedia, newEventNames, newTagNames, extraHeader, mediaTitle) {
        allMedia = newAllMedia;
        eventNames = newEventNames;
        tagNames = newTagNames;

        if (extraHeader) {
          const extraHeaderEle = document.querySelector('#extra_header');
          removeAllChildren(extraHeaderEle);

          const outerSpan = document.createElement('span');
          const anchor = document.createElement('a');
          anchor.href = extraHeader.link;
          const innerSpan = document.createElement('span');
          innerSpan.className = 'main_view';
          innerSpan.innerText = extraHeader.description;

          anchor.appendChild(innerSpan);
          outerSpan.appendChild(anchor);
          extraHeaderEle.appendChild(outerSpan);
        }

        setPageTitle(mediaTitle);
        showMedia();
        populateSearchValuesFromUrl();
      }

      function searchPageLinkGenerator(event, criterias, matchPolicy = 'all') {
        const parts = [];
        for (criteria of criterias) {
          // field,op,value
          parts.push(criteria.join(','));
        }

        const search = generateSearchUrl(parts, matchPolicy);

        // Check to see if the user control clicked the URL to request it be opened in a new tab.
        if (event.ctrlKey || event.which === 2 || event.which === 3) {
          event.preventDefault();
          event.stopPropagation();
          window.open(search, '_blank');
        } else {
          window.history.pushState({}, '', search);
          processJson(populateMedia);
        }
      }

      function writeCsvRow(cols) {
        let ret = '';
        for (let i = 0; i < cols.length; i += 1) {
          if (i > 0) {
            ret += ',';
          }
          ret += `"${encodeURIComponent(cols[i])}"`;
        }
        ret += encodeURIComponent('\n');

        return ret;
      }

      function getCsvUriData() {
        let ret = 'data:text/csv;charset=utf-8,';

        ret += writeCsvRow(['ID', 'Type', 'Path', 'Original Size', 'Original Size w/ Artifacts',
                            'Rating', 'Width', 'Height', 'Exposure Time', 'Event ID', 'Latitude',
                            'Longitude', 'Title', 'Camera', 'Camera Settings']);

        for (const media of allMedia) {
          const cols = [];
          cols.push(media.id);
          cols.push(media.type);
          cols.push(media.link);
          cols.push('filesize' in media ? media.filesize.toString() : '');
          cols.push('artifact_filesize' in media ? media.artifact_filesize.toString() : '');
          cols.push('rating' in media ? media.rating.toString() : '');
          cols.push('width' in media ? media.width.toString() : '');
          cols.push('height' in media ? media.height.toString() : '');
          cols.push('exposure_time' in media ? media.exposure_time : '');
          cols.push('event_id' in media ? media.event_id.toString() : '');
          cols.push('lat' in media ? media.lat.toString() : '');
          cols.push('lon' in media ? media.lon.toString() : '');
          cols.push('title' in media ? media.title : '');
          cols.push('camera' in media ? media.camera : '');
          cols.push('exif' in media ? media.exif.join(' ') : '');
          ret += writeCsvRow(cols);
        }

        return ret;
      }

      function downloadCsv(event) {
        if (event.detail !== 1) {
          return;
        }

        const link = document.createElement('a');
        link.href = getCsvUriData();
        link.download = 'media.csv';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      function windowSizeChanged() {
        const prevMobileView = isMobileView;
        isMobileView = showMobileView();
        if (prevMobileView !== isMobileView) {
          showMedia();
        }
      }

      function populateMediaAnchorTag(anchor, media) {
        if (media.type === 'events') {
          anchor.href = '#';
          const search = [['Event ID', 'equals', media.event_id]];

          /*
           * When searching for events by year, check to see if the JSON contains an entry
           * for the current year. If so, use that since thumbnails and stats are generated
           * for each year that the event spans.
           */
          if (currentYearView !== null) {
            search.push(['Year', 'equals', currentYearView]);
            if ('years' in media) {
              for (const yearBlock of media.years) {
                if (yearBlock.year === currentYearView) {
                  yearBlock.title = media.title;
                  if ('comment' in media) {
                    yearBlock.comment = media.comment;
                  }

                  media = yearBlock;
                }
              }
            }
          }

          search.push(['Type', 'is not a', 'events']);
          anchor.addEventListener('click', (event) => { searchPageLinkGenerator(event, search); });
        } else if (media.type === 'years') {
          anchor.href = '#';
          const search = [['Year', 'equals', media.id], ['Type', 'is a', 'events']];
          anchor.addEventListener('click', (event) => { searchPageLinkGenerator(event, search); });
        } else if (media.type === 'tags') {
          anchor.href = '#';
          const search = [['Tag Parent ID', 'equals', media.id], ['Tag ID', 'equals', media.id]];
          anchor.addEventListener('click', (event) => { searchPageLinkGenerator(event, search, 'any'); });
        } else {
          anchor.href = media.link;
          anchor.target = '_new';
        }

        return media;
      }

      function doShowMedia(pageNumber) {
        const pageSize = 24;
        const lastPageNumber = Math.ceil(allMedia.length / pageSize);
        if (pageNumber > lastPageNumber) {
          return;
        }

        const allMediaEle = document.querySelector('#all_media');

        const template = document.querySelector('#media_template');
        const startIdx = (pageNumber - 1) * pageSize;
        const searchLinkGenerator = function (field, op, val) {
          return `href="#" onclick="searchPageLinkGenerator(event, [['${field}', '${op}', '${val}']]);"`;
        };

        for (let media of allMedia.slice(startIdx, startIdx + pageSize)) {
          const clone = template.content.cloneNode(true);
          const mediaEle = clone.querySelector('.media_dyn');

          const anchor = clone.querySelector('a');

          // See the comment above for why the media element can be overridden for the event search.
          media = populateMediaAnchorTag(anchor, media);

          if (alwaysShowAnimations && media.motion_photo) {
            const img = clone.querySelector('img');
            if (isMobileView) {
              img.src = media.motion_photo.sq_gif;
              mediaEle.className = 'media';
            } else {
              img.src = media.motion_photo.reg_gif;
              mediaEle.style.width = `${media.thumbnail.reg_width}px`;
            }
          } else {
            const img = clone.querySelector('img');
            if (isMobileView || !('reg' in media.thumbnail)) {
              img.src = media.thumbnail.sq;
              if (media.motion_photo) {
                img.addEventListener('mouseover', () => { img.src = media.motion_photo.sq_gif; });
                img.addEventListener('mouseleave', () => { img.src = media.thumbnail.sq; });
                img.addEventListener('touchstart', () => { img.src = media.motion_photo.sq_gif; });
                img.addEventListener('touchend', () => { img.src = media.thumbnail.sq; });
              }
              mediaEle.className = 'media';
            } else {
              img.src = media.thumbnail.reg;
              if (media.motion_photo) {
                img.addEventListener('mouseover', () => { img.src = media.motion_photo.reg_gif; });
                img.addEventListener('mouseleave', () => { img.src = media.thumbnail.reg; });
                img.addEventListener('touchstart', () => { img.src = media.motion_photo.reg_gif; });
                img.addEventListener('touchend', () => { img.src = media.thumbnail.reg; });
              }
              mediaEle.style.width = `${media.thumbnail.reg_width}px`;
            }
          }

          if (media.title) {
            const name = `title${media.type}${media.id}`;
            const title = clone.querySelector('.media_title');
            title.style.display = metadataDisplay;
            title.appendChild(getExpandableString(name, media.title));
          }

          if (media.comment) {
            const name = `comment${media.type}${media.id}`;
            const comment = clone.querySelector('.media_comment');
            comment.style.display = metadataDisplay;
            comment.appendChild(getExpandableString(name, media.comment));
          }

          const metadata = clone.querySelector('.media_metadata');
          metadata.style.display = metadataDisplay;
          metadata.innerHTML = createMediaStatsHtml(media, eventNames, tagNames,
                                                    searchLinkGenerator, false);

          allMediaEle.appendChild(clone);
        }

        currentPageNumber = pageNumber;
      }

      function showMedia() {
        const allMediaEle = document.querySelector('#all_media');

        if (allMedia == null) {
          removeAllChildren(allMediaEle);
          return;
        }

        document.querySelector('.search_controls').style.display = 'block';
        document.querySelector('#search_criterias').style.display = 'block';

        if (allMedia.length === 0) {
          allMediaEle.innerHTML = "<div class='notfound'>No results found</div>";
          hideResultsInfo();
          return;
        }

        removeAllChildren(allMediaEle);

        doShowMedia(1);

        const params = window.location.search.startsWith('?') ? window.location.search : '?';

        document.querySelector('#screensaver_link').href = `screensaver.html${params}&photo_update_secs=30&reinstate_screensaver_secs=300&kiosk=0`;

        for (const ele of document.querySelectorAll('.header_links')) {
          ele.style.display = 'block';
        }

        document.querySelector('#csv_link').addEventListener('click', (event) => { downloadCsv(event); });

        document.querySelector('.summary_stats').innerHTML = createAllStatsHtml();

        window.scrollTo(0, 0);
      }

      function windowScrolled() {
        if (window.innerHeight + window.scrollY >= (document.body.offsetHeight * 0.90)) {
          doShowMedia(currentPageNumber + 1);
        }
      }

      function clearSearchCriteria() {
        window.history.pushState({}, '', 'search.html');
        processJson(populateMedia);
      }

      window.addEventListener('scroll', windowScrolled, false);
      window.addEventListener('resize', windowSizeChanged, false);

      window.onpopstate = function () {
        processJson(populateMedia);
      };
    </script>
  </body>
</html>
