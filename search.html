<!DOCTYPE html>
<html lang="en">
  <!--
      SPDX-License-Identifier: Apache-2.0
      Copyright (C) 2020-2021 Brian Masney <masneyb@onstation.org>
  -->

  <head>
    <meta name="viewport" content="width=device-width"/>
    <meta charset="UTF-8"/>
    <title>Search</title>
    <link rel="stylesheet" type="text/css" href="search.css"/>
    <script type="text/javascript" src="search-controls.js"></script>
    <script type="text/javascript" src="search-csv.js"></script>
    <script type="text/javascript" src="search-engine.js"></script>
    <script type="text/javascript" src="search-slideshow.js"></script>
    <script type="text/javascript" src="swiped-events.js"></script>
    <script type="text/javascript" src="media.js" defer="defer" onLoad="processJson(populateMedia); checkForPhotoFrameMode();" onError="jsonLoadError();"></script>
  </head>

  <body>
    <span id="title" class="page_title">Search</span>
    <span class="summary_stats"></span>
    <span class="header_links" style="display: none">
      <a class="header_link" id="toggle_fullscreen" href="#" onClick="toggleFullscreen();">Fullscreen</a>
      <a class="header_link" id="toggle_size" href="#" onClick="toggleImageSize();"></a>
      <a class="header_link" id="toggle_metadata" href="#" onClick="toggleMetadata();"></a>
      <a class="header_link" id="toggle_animations" href="#" onClick="toggleAnimations();"></a>
      <a class="header_link" href="#" onClick="slideshowClicked();">Slideshow</a>
      <a class="header_link" href="#" id="csv_link">CSV</a>
    </span>
    <span id="tag_parents" style="display: none;"></span>

    <span class="main_views">
      <span>
        <a href="#" onclick="searchPageLinkGenerator(event, []);"><span class="main_view">Date</span></a>
      </span>
      <span>
        <a href="#" onclick="searchPageLinkGenerator(event, [['Type', 'is a', 'events']]);"><span id="events_link" class="main_view">Event</span></a>
      </span>
      <span>
        <a href="#" onclick="searchPageLinkGenerator(event, [['Type', 'is a', 'years']]);"><span id="years_link" class="main_view">Year</span></a>
      </span>
      <span>
        <a href="#" onclick="searchPageLinkGenerator(event, [['Type', 'is a', 'tags'], ['Tag Parent ID', 'is not set']]);"><span id="tags_link" class="main_view">Tag</span></a>
      </span>
      <span id="extra_header"></span>
    </span>

    <span id="search_criterias" style="display: none"></span>

    <span class="search_controls" style="display: none">
      <input type="button" onClick="addSearchInputRow();" value="+"></input>
      <select id="match_policy" onChange="updateSearchCriteria();">
        <option value="any">Match Any</option>
        <option value="all">Match All</option>
        <option value="none">Match None</option>
      </select>
      <select id="sortby" onChange="updateSearchCriteria();">
        <option value="takenZA">Sort taken Z-A</option>
        <option value="takenAZ">Sort taken A-Z</option>
        <option value="createdZA">Sort added Z-A</option>
        <option value="random">Sort random</option>
      </select>
      <input type="button" onClick="updateSearchCriteria();" value="Search"></input>
      <input type="button" onClick="clearSearchCriteria();" value="Clear"></input>
    </span>

    <div id="all_media"><div class='loading'>Loading</div></div>

    <span class="generated_at">Site generated from
      <a href="https://wiki.gnome.org/Apps/Shotwell">Shotwell</a> library
      <span id="generated_timestamp"></span> by
      <a href="https://github.com/masneyb/shotwell-site-generator">shotwell-site-generator</a>
      <span id="app_version"></span>.
    </span>

    <div id="fullimage_background" style="display: none;"></div>
    <div id="fullimage_container" style="display: none;">
      <a id="close" href="#" onclick="exitImageFullscreen();">&times;</a>
      <img id="fullimage"></img>
      <div id="description"></div>
    </div>

    <template id="search_criteria_row">
      <span class="search_criteria">
        <select class="search_field"></select>
        <select class="search_op"></select>
        <span class="search_values"></span>
        <input class="search_delete_row" type="button" value="X"></input>
      </span>
    </template>

    <script type="text/javascript">
      function showMobileView() {
        return window.innerWidth < 900;
      }

      let currentPageNumber = 1;
      let allMedia = null;
      let dateRange = null;
      let metadataDisplay = 'block';
      let alwaysShowAnimations = false;
      let isMobileView = showMobileView();
      let showSmallIcons = isMobileView;
      let currentYearView = null;
      let lastSmallMediaItems = null;

      function jsonLoadError() {
        const allMediaEle = document.querySelector('#all_media');
        allMediaEle.innerHTML = "<div class='error'>Error loading media</div>";
      }

      function getMetadataDisplay() {
        return showSmallIcons ? 'none' : metadataDisplay;
      }

      function updateSettingsText() {
        document.querySelector('#toggle_animations').innerText = alwaysShowAnimations ? 'Stop Animations' : 'Show Animations';

        if (showSmallIcons) {
          document.querySelector('#toggle_size').innerText = 'Large Icons';
          document.querySelector('#toggle_metadata').style.display = 'none';
        } else {
          document.querySelector('#toggle_size').innerText = 'Small Icons';
          document.querySelector('#toggle_metadata').style.display = 'inline-block';
        }

        document.querySelector('#toggle_metadata').innerText = metadataDisplay === 'none' ? 'Show Metadata' : 'Hide Metadata';
        for (const name of ['.media_metadata', '.media_title', '.media_comment']) {
          for (const ele of document.querySelectorAll(name)) {
            ele.style.display = getMetadataDisplay();
          }
        }
      }

      function toggleMetadata() {
        metadataDisplay = metadataDisplay === 'none' ? 'block' : 'none';
        updateSettingsText();
      }

      function toggleAnimations() {
        alwaysShowAnimations = !alwaysShowAnimations;
        updateSettingsText();
        showMedia();
      }

      function toggleImageSize() {
        showSmallIcons = !showSmallIcons;
        updateSettingsText();
        showMedia();
      }

      function createAllStatsHtml() {
        const totalsByTypes = {};
        let artifactSize = 0;
        let groupSize = 0;

        for (const media of allMedia) {
          let type = null;
          if (media.type === 'raw_photo' || media.type === 'motion_photo') {
            type = 'photo';
          } else {
            type = media.type;
          }

          if (!(type in totalsByTypes)) {
            totalsByTypes[type] = 1;
          } else {
            totalsByTypes[type] += 1;
          }

          if ('artifact_filesize' in media) {
            artifactSize += media.artifact_filesize;
          } else if ('filesize' in media && type !== 'tags') {
            groupSize += media.filesize;
          }
        }

        const ret = [];
        if ('photo' in totalsByTypes) {
          ret.push(`<span class="stat">${getNumberString(totalsByTypes.photo, 'photo', 'photos')}</span>`);
        }
        if ('video' in totalsByTypes) {
          ret.push(`<span class="stat">${getNumberString(totalsByTypes.video, 'video', 'videos')}</span>`);
        }
        if ('events' in totalsByTypes && totalsByTypes.events > 1) {
          ret.push(`<span class="stat">${totalsByTypes.events.toLocaleString()} events</span>`);
        }
        if ('years' in totalsByTypes && totalsByTypes.years > 1) {
          ret.push(`<span class="stat">${totalsByTypes.years.toLocaleString()} years</span>`);
        }
        if ('tags' in totalsByTypes && totalsByTypes.tags > 1) {
          ret.push(`<span class="stat">${totalsByTypes.tags.toLocaleString()} tags</span>`);
        }

        if (artifactSize > 0) {
          ret.push(`<span class="stat">${getPrettyFileSize(artifactSize)}</span>`);
        } else if (groupSize > 0) {
          ret.push(`<span class="stat">${getPrettyFileSize(groupSize)}</span>`);
        }

        if (dateRange) {
          ret.push(`<span class="stat">${dateRange}</span>`);
        }

        return ret.join(' ');
      }

      function jsHideShow(hideElement, showElement) {
        document.getElementById(showElement).style.display = 'block';
        document.getElementById(hideElement).style.display = 'none';
      }

      function getExpandableString(name, value) {
        const trimmedValue = value.trim();
        if (trimmedValue.length < 150 && !trimmedValue.includes('\n')) {
          return document.createTextNode(trimmedValue);
        }

        const shortId = `${name}_short`;
        const longId = `${name}_long`;

        const parentEle = document.createElement('span');

        let ele = document.createElement('span');
        ele.id = shortId;
        ele.style.display = 'block';
        ele.innerHTML = `${trimmedValue.substring(0, 140).trim()}... <span class='more_less' onClick='jsHideShow("${shortId}", "${longId}");'>More</span>`;
        parentEle.appendChild(ele);

        ele = document.createElement('span');
        ele.id = longId;
        ele.style.display = 'none';
        const longValEscaped = trimmedValue.replace(/</g, '&lt;').replace(/>/g, '&gt').replace(/\n/g, '<br/>');
        ele.innerHTML = `${longValEscaped} <span class='more_less' onClick='jsHideShow("${longId}", "${shortId}");'>Less</span>`;
        parentEle.appendChild(ele);

        return parentEle;
      }

      function hideResultsInfo() {
        removeAllChildren(document.querySelector('.summary_stats'));
        for (const search of ['.header_links']) {
          for (const ele of document.querySelectorAll(search)) {
            ele.style.display = 'none';
          }
        }
      }

      function searchPageLinkGenerator(event, criterias, matchPolicy = 'all') {
        const parts = [];
        for (criteria of criterias) {
          // field,op,value
          parts.push(criteria.join(','));
        }

        const search = generateSearchUrl(parts, matchPolicy);

        // Check to see if the user control clicked the URL to request it be opened in a new tab.
        if (event.ctrlKey || event.which === 2 || event.which === 3) {
          event.preventDefault();
          event.stopPropagation();
          window.open(search, '_blank');
        } else {
          window.history.pushState({}, '', search);
          processJson(populateMedia);
        }
      }

      function showParentTags(searchTag) {
        const tagParentsEle = document.querySelector('#tag_parents');
        removeAllChildren(tagParentsEle);

        if (searchTag !== undefined) {
          let parentTag = searchTag.parent_tag_id;
          let firstChild = true;
          while (parentTag !== null) {
            const tag = tags[parentTag];

            const span = document.createElement('span');
            span.className = 'header_link';

            if (firstChild) {
              span.appendChild(document.createTextNode('Parent Tag: '));
              firstChild = false;
            }

            const anchor = document.createElement('a');
            anchor.innerText = tag.title;
            anchor.href = '#';
            anchor.onclick = (event) => { searchPageLinkGenerator(event, [['Tag ID', 'equals', tag.id]]); };
            span.appendChild(anchor);

            tagParentsEle.appendChild(span);

            parentTag = tag.parent_tag_id;
          }
          tagParentsEle.style.display = 'block';
        } else {
          tagParentsEle.style.display = 'none';
        }
      }

      function setPageTitle(mediaTitle) {
        currentYearView = null;

        // Search criteria can be chained in any order. Get the distinct types and order below.
        let eventTitle = null;
        let yearTitle = null;
        let tagTitle = null;
        let searchTag;

        const allCriteria = getSearchCriteria();
        for (const criteria of allCriteria) {
          if (criteria.field.title === 'Type' && criteria.op.descr === 'is a' && criteria.searchValues[0] === 'years') {
            yearTitle = `${mediaTitle}: All Years`;
          } else if (criteria.field.title === 'Year' && criteria.op.descr === 'equals') {
            yearTitle = `${mediaTitle}: Year ${criteria.searchValues[0]}`;
            // Used for generating search links when searching for events.
            currentYearView = criteria.searchValues[0];
          } else if (criteria.field.title === 'Type' && criteria.op.descr === 'is a' && criteria.searchValues[0] === 'events') {
            eventTitle = `${mediaTitle}: All Events`;
          } else if (criteria.field.title === 'Event ID' && criteria.op.descr === 'equals') {
            let eventName = eventNames[criteria.searchValues[0]];
            if (eventName === undefined) {
              eventName = 'Unknown event';
            }
            eventTitle = `${mediaTitle}: ${eventName}`;
          } else if (criteria.field.title === 'Type' && criteria.op.descr === 'is a' && criteria.searchValues[0] === 'tags') {
            tagTitle = `${mediaTitle}: All Tags`;
          } else if (criteria.field.title === 'Tag ID' && criteria.op.descr === 'equals') {
            searchTag = tags[criteria.searchValues[0]];
            tagTitle = `${mediaTitle}: ${searchTag !== undefined ? searchTag.title : 'Unknown tag'}`;
          }
        }

        const titles = [[eventTitle, 'events_link'], [yearTitle, 'years_link'],
                        [tagTitle, 'tags_link'], [`${mediaTitle}: Search`, null]];
        const preferredTitle = titles.find((ent) => ent[0] !== null);

        document.title = preferredTitle[0];
        const ele = document.querySelector('#title');
        if (ele) {
          ele.innerText = document.title;
        }

        if (preferredTitle[1] !== null) {
          document.querySelector(`#${preferredTitle[1]}`).classList.add('main_view_selected');
        }
        for (const tagName of ['years_link', 'events_link', 'tags_link']) {
          if (tagName !== preferredTitle[1]) {
            document.querySelector(`#${tagName}`).classList.remove('main_view_selected');
          }
        }

        showParentTags(searchTag);
      }

      function populateMedia(newAllMedia, extraHeader, mediaTitle, newDateRange) {
        allMedia = newAllMedia;
        dateRange = newDateRange;

        if (extraHeader) {
          const extraHeaderEle = document.querySelector('#extra_header');
          removeAllChildren(extraHeaderEle);

          const outerSpan = document.createElement('span');
          const anchor = document.createElement('a');
          anchor.href = extraHeader.link;
          const innerSpan = document.createElement('span');
          innerSpan.className = 'main_view';
          innerSpan.innerText = extraHeader.description;

          anchor.appendChild(innerSpan);
          outerSpan.appendChild(anchor);
          extraHeaderEle.appendChild(outerSpan);
        }

        setPageTitle(mediaTitle);
        showMedia();
        populateSearchValuesFromUrl();
      }

      function windowSizeChanged() {
        const prevMobileView = isMobileView;
        isMobileView = showMobileView();
        if (prevMobileView !== isMobileView) {
          showMedia();
        }
      }

      function populateMediaAnchorTag(anchor, media, allMediaIndex) {
        if (media.type === 'events') {
          anchor.href = '#';
          const search = [['Event ID', 'equals', media.event_id]];

          /*
           * When searching for events by year, check to see if the JSON contains an entry
           * for the current year. If so, use that since thumbnails and stats are generated
           * for each year that the event spans.
           */
          if (currentYearView !== null) {
            search.push(['Year', 'equals', currentYearView]);
            if ('years' in media) {
              for (const yearBlock of media.years) {
                if (yearBlock.year === currentYearView) {
                  yearBlock.title = media.title;
                  if ('comment' in media) {
                    yearBlock.comment = media.comment;
                  }

                  media = yearBlock;
                }
              }
            }
          }

          search.push(['Type', 'is not a', 'events']);
          anchor.onclick = (event) => { searchPageLinkGenerator(event, search); };
        } else if (media.type === 'years') {
          anchor.href = '#';
          const search = [['Year', 'equals', media.id]];
          anchor.onclick = (event) => { searchPageLinkGenerator(event, search); };
        } else if (media.type === 'tags') {
          anchor.href = '#';
          const search = [['Tag ID', 'equals', media.id]];
          anchor.onclick = (event) => { searchPageLinkGenerator(event, search); };
        } else if (media.type === 'video') {
          anchor.href = media.link;
          anchor.target = '_new';
        } else {
          anchor.href = '#';
          const link = media.link;
          anchor.onclick = () => { enterSlideshowMode(allMediaIndex); };
        }

        return media;
      }

      function windowScrolled() {
        if (window.innerHeight + window.scrollY >= (document.body.offsetHeight * 0.85)) {
          doShowMedia(currentPageNumber + 1);
        }
      }

      function showLargerIconInMixedMode(media) {
        return media.rating === 5 || (media.type !== 'photo' && media.type !== 'video');
      }

      function createMediaElement(index, media) {
        const mediaEle = document.createElement('span');
        mediaEle.className = 'media_dyn';

        const anchor = document.createElement('a');
        const mediaThumbSpan = document.createElement('span');
        mediaThumbSpan.className = 'media_thumb';
        const img = document.createElement('img');
        mediaThumbSpan.appendChild(img);
        anchor.appendChild(mediaThumbSpan);
        mediaEle.appendChild(anchor);

        // See the comment above for why the media element can be overridden for the event search.
        media = populateMediaAnchorTag(anchor, media, index);

        if (alwaysShowAnimations && media.motion_photo) {
          if (showSmallIcons) {
            if (showLargerIconInMixedMode(media)) {
              img.src = media.motion_photo.medium_gif;
              mediaEle.className = 'media_medium';
            } else {
              img.src = media.motion_photo.small_gif;
              mediaEle.className = 'media_small';
            }
          } else if (isMobileView) {
            img.src = media.motion_photo.sq_gif;
            mediaEle.className = 'media';
          } else {
            img.src = media.motion_photo.reg_gif;
            mediaEle.style.width = `${media.thumbnail.reg_width}px`;
          }
        } else {
          if (showSmallIcons) {
            if (showLargerIconInMixedMode(media)) {
              img.src = media.thumbnail.medium;
              if (media.motion_photo) {
                img.onmouseover = () => { img.src = media.motion_photo.medium_gif; };
                img.onmouseleave = () => { img.src = media.thumbnail.medium; };
                img.ontouchstart = () => { img.src = media.motion_photo.medium_gif; };
                img.ontouchend = () => { img.src = media.thumbnail.medium; };
              }
              mediaEle.className = 'media_medium';
            } else {
              img.src = media.thumbnail.small;
              if (media.motion_photo) {
                img.onmouseover = () => { img.src = media.motion_photo.small_gif; };
                img.onmouseleave = () => { img.src = media.thumbnail.small; };
                img.ontouchstart = () => { img.src = media.motion_photo.small_gif; };
                img.ontouchend = () => { img.src = media.thumbnail.small; };
              }
              mediaEle.className = 'media_small';
            }
          } else if (isMobileView || !('reg' in media.thumbnail)) {
            img.src = media.thumbnail.sq;
            if (media.motion_photo) {
              img.onmouseover = () => { img.src = media.motion_photo.sq_gif; };
              img.onmouseleave = () => { img.src = media.thumbnail.sq; };
              img.ontouchstart = () => { img.src = media.motion_photo.sq_gif; };
              img.ontouchend = () => { img.src = media.thumbnail.sq; };
            }
            mediaEle.className = 'media';
          } else {
            img.src = media.thumbnail.reg;
            if (media.motion_photo) {
              img.onmouseover = () => { img.src = media.motion_photo.reg_gif; };
              img.onmouseleave = () => { img.src = media.thumbnail.reg; };
              img.ontouchstart = () => { img.src = media.motion_photo.reg_gif; };
              img.ontouchend = () => { img.src = media.thumbnail.reg; };
            }
            mediaEle.style.width = `${media.thumbnail.reg_width}px`;
          }
        }

        if (!showSmallIcons) {
          if (media.title) {
            const name = `title${media.type}${media.id}`;
            const title = document.createElement('span');
            title.className = 'media_title';
            title.style.display = getMetadataDisplay();
            if (media.title_prefix) {
              title.appendChild(getExpandableString(name, media.title_prefix + media.title));
            } else {
              title.appendChild(getExpandableString(name, media.title));
            }
            mediaEle.appendChild(title);
          }

          if (media.comment) {
            const name = `comment${media.type}${media.id}`;
            const comment = document.createElement('span');
            comment.className = 'media_comment';
            comment.style.display = getMetadataDisplay();
            comment.appendChild(getExpandableString(name, media.comment));
            mediaEle.appendChild(comment);
          }

          const metadata = document.createElement('span');
          metadata.className = 'media_metadata';
          metadata.style.display = getMetadataDisplay();
          mediaEle.appendChild(metadata);

          const searchLinkGenerator = function (field, op, val) {
            return `href="#" onclick="searchPageLinkGenerator(event, [['${field}', '${op}', '${val}']]);"`;
          };
          metadata.innerHTML = createMediaStatsHtml(media, eventNames, tags, searchLinkGenerator, false);
        }

        return mediaEle
      }

      function createMediaSmallContainer() {
        const ele = document.createElement('span');
        ele.className = 'media_small_container';
        ele.appendChild(createMediaElement(lastSmallMediaItems[0][0], lastSmallMediaItems[0][1]));
        if (lastSmallMediaItems.length >= 2) {
          ele.appendChild(createMediaElement(lastSmallMediaItems[1][0], lastSmallMediaItems[1][1]));
          if (lastSmallMediaItems.length >= 3) {
            ele.appendChild(createMediaElement(lastSmallMediaItems[2][0], lastSmallMediaItems[2][1]));
            if (lastSmallMediaItems.length >= 4) {
              ele.appendChild(createMediaElement(lastSmallMediaItems[3][0], lastSmallMediaItems[3][1]));
            }
          }
        }
        return ele;
      }

      function doShowMedia(pageNumber) {
        const pageSize = showSmallIcons ? 48 : 12;
        const lastPageNumber = Math.ceil(allMedia.length / pageSize);
        if (pageNumber > lastPageNumber) {
          return;
        }

        const allMediaEle = document.querySelector('#all_media');

        const startIdx = (pageNumber - 1) * pageSize;

        for (let [index, media] of allMedia.slice(startIdx, startIdx + pageSize).entries()) {
          if (showSmallIcons) {
            if (showLargerIconInMixedMode(media)) {
              allMediaEle.appendChild(createMediaElement(startIdx + index, media));
            } else {
              lastSmallMediaItems.push([startIdx + index, media]);
              if (lastSmallMediaItems.length === 4) {
                allMediaEle.appendChild(createMediaSmallContainer());
                lastSmallMediaItems = [];
              }
            }
          } else {
            allMediaEle.appendChild(createMediaElement(startIdx + index, media));
          }
        }

        currentPageNumber = pageNumber;
        if (pageNumber === lastPageNumber && lastSmallMediaItems != null && lastSmallMediaItems.length > 0) {
          allMediaEle.appendChild(createMediaSmallContainer());
          lastSmallMediaItems = [];
        }

        // Ensure that the viewport is filled with media for higher screen resolutions.
        windowScrolled();
      }

      function showMedia() {
        const allMediaEle = document.querySelector('#all_media');
        lastSmallMediaItems = [];

        if (allMedia == null) {
          removeAllChildren(allMediaEle);
          return;
        }

        document.querySelector('.search_controls').style.display = 'block';
        document.querySelector('#search_criterias').style.display = 'block';

        if (allMedia.length === 0) {
          allMediaEle.innerHTML = "<div class='notfound'>No results found</div>";
          hideResultsInfo();
          return;
        }

        removeAllChildren(allMediaEle);
        window.scrollTo(0, 0);

        window.setTimeout(() => {
          // In case there are duplicate timeouts, remove the children again.
          removeAllChildren(allMediaEle);
          window.scrollTo(0, 0);

          doShowMedia(1);

          for (const ele of document.querySelectorAll('.header_links')) {
            ele.style.display = 'block';
          }

          document.querySelector('#csv_link').onclick = (event) => { downloadCsv(event); };

          document.querySelector('.summary_stats').innerHTML = createAllStatsHtml();
        }, 0);
      }

      function clearSearchCriteria() {
        window.history.pushState({}, '', 'search.html');
        processJson(populateMedia);
      }

      updateSettingsText();
      window.onscroll = windowScrolled;
      window.onresize = windowSizeChanged;

      const fullImageEle = document.querySelector('#fullimage');
      fullImageEle.onclick = toggleFullscreenDescription;

      document.onkeydown = (event) => {
        if (event.key === 'ArrowLeft') {
          showPreviousImageFullscreen(event);
        } else if (event.key === 'ArrowRight') {
          showNextImageFullscreen(event, true);
        } else if (event.key === 'Escape') {
          exitImageFullscreen();
        } else if (event.key === ' ') {
          toggleFullscreenDescription();
        }
      };
      document.onfullscreenchange = (evt) => {
        if (!isFullscreen()) {
          exitImageFullscreen();
        }
      };
      document.addEventListener('swiped-left', (e) => { showNextImageFullscreen(e, true); });
      document.addEventListener('swiped-right', showPreviousImageFullscreen);
      document.addEventListener('swiped-down', (e) => {
        if (!inPhotoFrameMode) {
          exitImageFullscreen();
        }
      });

      window.onpopstate = function () {
        processJson(populateMedia);
      };
    </script>
  </body>
</html>
