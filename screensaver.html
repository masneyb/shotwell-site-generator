<html>
  <body style="text-align:center; background:black;">
    <img id="image" style="width:100%; height:100%; object-fit:contain;"/>
    <script>
      function getQueryParameter(name, defaultValue) {
        var urlParams = new URLSearchParams(window.location.search);
        return urlParams.has(name) ? urlParams.get(name) : defaultValue;
      }

      function getIntQueryParameter(name, defaultValue) {
        var val = getQueryParameter(name, null);
        return val != null ? parseInt(val, 10) : defaultValue;
      }

      function isValidMedia(media) {
        if (media["media_id"].startsWith("video"))
          return false;

        var minTime = getQueryParameter("min_time", "");
        if (minTime != "" && media["exposure_time"].localeCompare(minTime) < 0)
          return false;

        var maxTime = getIntQueryParameter("max_time", "");
        if (maxTime != "" && media["exposure_time"].localeCompare(maxTime) > 0)
          return false;

        return true;
      }

      var allMedia = null;
      var curIdx = 0;

      function shuffleMedia() {
        for (var i = allMedia.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * i);
          const tmp = allMedia[i];
          allMedia[i] = allMedia[j];
          allMedia[j] = tmp;
        }
      }

      function updateImage() {
        if (allMedia == null || allMedia.length == 0)
          return;

        document.getElementById("image").src = allMedia[curIdx].link;

        curIdx++;
        if (curIdx == allMedia.length) {
           curIdx = 0;
           shuffleMedia();
        }
      }

      function updateJson() {
        var xmlhttp = new XMLHttpRequest();
        xmlhttp.onreadystatechange = function() {
          if (this.readyState == 4 && this.status == 200) {
            var loadedMedia = JSON.parse(this.responseText);
            allMedia = [];
            for (var i = 0; i < loadedMedia["media"].length; i++) {
              if (!isValidMedia(loadedMedia["media"][i]))
                continue;

              allMedia.push(loadedMedia["media"][i]);
            }

            shuffleMedia();
            updateImage();
          }
        };

        // Add current timstamp to query to avoid caching
        xmlhttp.open("GET", "media.json?ts=" + Date.now(), true);
        xmlhttp.send();
      }

      // 6 hours
      var jsonUpdateSecs = getIntQueryParameter("json_update_secs", 21600);
      setInterval(updateJson, jsonUpdateSecs * 1000);
      updateJson();

      // 10 seconds
      var photoUpdateSecs = getIntQueryParameter("photo_update_secs", 10);
      setInterval(updateImage, photoUpdateSecs * 1000);
    </script>
  </body>
</html>
