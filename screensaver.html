<html lang="en">
  <head>
    <meta name="viewport" content="width=device-width"/>
    <meta charset="UTF-8"/>
    <script type="text/javascript" src="search.js"></script>
  </head>

  <body style="text-align:center; background:black; margin: 0px;">
    <img id="image" style="width:100%; height:100%; object-fit:contain; image-orientation: from-image;"/>

    <script>
      var shownPhotos = null;
      var curIdx = 0;

      function updateImage() {
        if (shownPhotos == null || shownPhotos.length == 0)
          return;

        document.getElementById("image").src = shownPhotos[curIdx].link;

        curIdx++;
        if (curIdx == shownPhotos.length) {
           curIdx = 0;
           shuffleArray(shownPhotos);
        }
      }

      function updateJson() {
        var xmlhttp = new XMLHttpRequest();
        xmlhttp.onreadystatechange = function() {
          if (this.readyState == 4 && this.status == 200) {
            var allMedia = performSearch(JSON.parse(this.responseText));

            shownPhotos = [];
            for (media of allMedia) {
              if (media["type"] != "photo")
                continue;

              shownPhotos.push(media);
            }

            shuffleArray(shownPhotos);
            updateImage();
          }
        };

        xmlhttp.open("GET", "media.json", true);
        xmlhttp.send();
      }

      updateJson();

      // 10 seconds
      var photoUpdateSecs = getIntQueryParameter("photo_update_secs", 10);
      setInterval(updateImage, photoUpdateSecs * 1000);

      /*
       * Refresh the page every 6 hours by default to ensure it gets the latest
       * copy of this page and to refresh the JSON.
       */
      var pageReloadSecs = getIntQueryParameter("page_reload_secs", 21600);
      window.setTimeout(window.location.reload.bind(window.location),
                        pageReloadSecs * 1000);

      if (getIntQueryParameter("kiosk", 0) == 1)
        document.body.style.cursor = "none";
    </script>
  </body>
</html>
